# ğŸ“‹ TASK-S1-04: ä¸‰å±‚æ¸²æŸ“æ¡†æ¶ + WPF å£³

> **Sprint**: 1  
> **è´Ÿè´£æ–¹**: Codex  
> **ä¼˜å…ˆçº§**: ğŸŸ¡ P1  
> **é¢„ä¼°å·¥æ—¶**: 10h  
> **çŠ¶æ€**: â³ å¾…å¼€å§‹

---

## 1. ç›®æ ‡

å®ç°ä¸‰å±‚æ¸²æŸ“æ¶æ„ï¼ˆGrid/Waveform/Overlayï¼‰å’Œ WPF é›†æˆï¼ŒéªŒè¯ FPS åŸºçº¿ã€‚

---

## 2. è¾“å…¥ï¼ˆå¿…è¯»æ–‡ä»¶ï¼‰

| æ–‡ä»¶ | é‡ç‚¹ç« èŠ‚ |
|------|----------|
| `spec/00_CONSTITUTION.md` | é“å¾‹6ï¼ˆæ¸²æŸ“çº¿ç¨‹åªDrawï¼‰ã€é“å¾‹3ï¼ˆMinMaxï¼‰ |
| `spec/ARCHITECTURE.md` | Â§5ï¼ˆæ¸²æŸ“å±‚ï¼‰ã€Â§6ï¼ˆUIå¸ƒå±€ï¼‰ |
| `spec/DECISIONS.md` | ADR-008ï¼ˆä¸‰å±‚æ¶æ„ï¼‰ |
| `spec/ACCEPTANCE_TESTS.md` | AT-05ï¼ˆFPSåŸºçº¿ï¼‰ |
| `handoff/renderer-device-api.md` | S1-03 äº§å‡º |
| `handoff/double-buffer-api.md` | S1-02 äº§å‡º |

---

## 3. è¾“å‡º

### 3.1 ä»£ç æ–‡ä»¶

```
src/Rendering/
â”œâ”€â”€ Layers/
â”‚   â”œâ”€â”€ ILayer.cs                 # å±‚æ¥å£
â”‚   â”œâ”€â”€ GridLayer.cs              # ç½‘æ ¼å±‚ï¼ˆç¼“å­˜ï¼‰
â”‚   â”œâ”€â”€ WaveformLayer.cs          # æ³¢å½¢å±‚ï¼ˆå®æ—¶ï¼‰
â”‚   â””â”€â”€ OverlayLayer.cs           # è¦†ç›–å±‚ï¼ˆå®æ—¶ï¼‰
â”œâ”€â”€ Composition/
â”‚   â”œâ”€â”€ LayerCompositor.cs        # å±‚åˆæˆå™¨
â”‚   â””â”€â”€ RenderLoop.cs             # æ¸²æŸ“å¾ªç¯
â””â”€â”€ WPF/
    â”œâ”€â”€ D3DImageHost.cs           # WPF D3D äº’æ“ä½œ
    â””â”€â”€ MonitorPanel.xaml(.cs)    # ç›‘æŠ¤é¢æ¿æ§ä»¶

src/App/
â””â”€â”€ MainWindow.xaml(.cs)          # ä¸»çª—å£

tests/Rendering.Tests/
â”œâ”€â”€ Layers/
â”‚   â””â”€â”€ LayerCompositorTests.cs
â””â”€â”€ Performance/
    â””â”€â”€ FpsBaselineTests.cs
```

### 3.2 äº¤æ¥æ–‡æ¡£

```
handoff/renderer-api.md
```

---

## 4. è®¾è®¡è§„æ ¼

### 4.1 ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœ€ç»ˆåˆæˆè¾“å‡º                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â–²                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚         â”‚                    â”‚                    â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Layer 3     â”‚      â”‚ Layer 2     â”‚      â”‚ Layer 1     â”‚    â”‚
â”‚  â”‚ Overlay     â”‚      â”‚ Waveform    â”‚      â”‚ Grid        â”‚    â”‚
â”‚  â”‚ (æ¯å¸§é‡ç»˜)  â”‚      â”‚ (æ¯å¸§é‡ç»˜)  â”‚      â”‚ (ç¼“å­˜çº¹ç†)  â”‚    â”‚
â”‚  â”‚             â”‚      â”‚             â”‚      â”‚             â”‚    â”‚
â”‚  â”‚ - å…‰æ ‡      â”‚      â”‚ - æ³¢å½¢çº¿æ¡  â”‚      â”‚ - èƒŒæ™¯      â”‚    â”‚
â”‚  â”‚ - æ ‡æ³¨      â”‚      â”‚ - æ•°æ®ç‚¹    â”‚      â”‚ - ç½‘æ ¼çº¿    â”‚    â”‚
â”‚  â”‚ - èœå•      â”‚      â”‚             â”‚      â”‚ - åˆ»åº¦/æ ‡ç­¾ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ILayer æ¥å£

```csharp
public interface ILayer : IDisposable
{
    /// <summary>å±‚åç§°</summary>
    string Name { get; }
    
    /// <summary>å±‚çº§ï¼ˆ0=æœ€åº•å±‚ï¼‰</summary>
    int ZOrder { get; }
    
    /// <summary>æ˜¯å¦éœ€è¦é‡ç»˜</summary>
    bool IsDirty { get; }
    
    /// <summary>æ¸²æŸ“åˆ°çº¹ç†</summary>
    void Render(RenderContext context);
    
    /// <summary>è·å–è¾“å‡ºçº¹ç†</summary>
    ID3D11ShaderResourceView GetTexture();
    
    /// <summary>æ ‡è®°éœ€è¦é‡ç»˜</summary>
    void Invalidate();
    
    /// <summary>å¤„ç†å¤§å°å˜åŒ–</summary>
    void Resize(int width, int height, float dpiScale);
}
```

### 4.3 GridLayerï¼ˆç¼“å­˜å±‚ï¼‰

```csharp
public class GridLayer : ILayer
{
    // æ¸²æŸ“åˆ°ç¦»å±çº¹ç†
    private ID3D11Texture2D _cacheTexture;
    private ID3D11RenderTargetView _cacheRtv;
    
    public void Render(RenderContext context)
    {
        if (!IsDirty) return;  // æœªå˜åŒ–åˆ™è·³è¿‡
        
        // åˆ‡æ¢åˆ°ç¼“å­˜çº¹ç†
        context.SetRenderTarget(_cacheRtv);
        
        // ç»˜åˆ¶ç½‘æ ¼
        DrawBackground();
        DrawGridLines();
        DrawAxisLabels();
        
        IsDirty = false;
    }
}
```

### 4.4 RenderLoop

```csharp
public class RenderLoop
{
    private readonly Stopwatch _frameTimer = new();
    private int _frameCount;
    
    public double CurrentFps { get; private set; }
    
    public void Run()
    {
        while (!_shouldStop)
        {
            _frameTimer.Restart();
            
            // 1. ä»åŒç¼“å†²è·å–æœ€æ–°æ•°æ®
            var snapshot = _dataBuffer.GetSnapshot();
            
            // 2. æ›´æ–°å„å±‚
            _waveformLayer.UpdateData(snapshot);
            
            // 3. æ¸²æŸ“å„å±‚
            foreach (var layer in _layers.OrderBy(l => l.ZOrder))
            {
                layer.Render(_context);
            }
            
            // 4. åˆæˆè¾“å‡º
            _compositor.Compose(_layers);
            
            // 5. å‘ˆç°
            _swapChain.Present(1);
            
            // 6. ç»Ÿè®¡ FPS
            UpdateFpsCounter();
        }
    }
}
```

---

## 5. WPF é›†æˆ

### 5.1 D3DImageHost

```csharp
/// <summary>
/// WPF D3D äº’æ“ä½œå®¿ä¸»
/// </summary>
public class D3DImageHost : FrameworkElement
{
    private D3DImage _d3dImage;
    private DeviceManager _deviceManager;
    
    public void Initialize()
    {
        // åˆ›å»ºå…±äº«è¡¨é¢
        _d3dImage = new D3DImage();
        _d3dImage.IsFrontBufferAvailableChanged += OnFrontBufferAvailableChanged;
    }
    
    protected override void OnRender(DrawingContext dc)
    {
        if (_d3dImage.IsFrontBufferAvailable)
        {
            _d3dImage.Lock();
            // æ¸²æŸ“åˆ°å…±äº«è¡¨é¢
            _renderLoop.RenderFrame();
            _d3dImage.AddDirtyRect(new Int32Rect(0, 0, Width, Height));
            _d3dImage.Unlock();
        }
        
        dc.DrawImage(_d3dImage, new Rect(RenderSize));
    }
}
```

### 5.2 MonitorPanel å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MonitorPanel                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Channel 1 (ç©ºç½‘æ ¼ï¼Œæ˜¾ç¤º "Channel 1" æ ‡ç­¾)               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Channel 2 (ç©ºç½‘æ ¼)                                      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Channel 3 (ç©ºç½‘æ ¼)                                      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Channel 4 (ç©ºç½‘æ ¼)                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  FPS: xxx | Frame Time: xxx ms | Status: Ready                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. éªŒæ”¶æ ‡å‡†

### 6.1 AT-05: FPS åŸºçº¿

```
æµ‹è¯•æ¡ä»¶ï¼š
- 4 é€šé“ç©ºç½‘æ ¼ï¼ˆGrid å±‚ï¼‰
- æ— æ³¢å½¢æ•°æ®ï¼ˆWaveform å±‚ç©ºï¼‰
- åˆ†è¾¨ç‡ 1280Ã—1024

æµ‹è¯•æ­¥éª¤ï¼š
1. å¯åŠ¨åº”ç”¨
2. è¿è¡Œ 5 åˆ†é’Ÿ
3. è®°å½• FPS ç»Ÿè®¡

éªŒæ”¶æ ‡å‡†ï¼š
- [ ] å¹³å‡ FPS â‰¥ 120
- [ ] FPS P99 â‰¥ 100
- [ ] å¸§æ—¶é—´ P99 < 12ms
- [ ] CPU å ç”¨ < 30%
- [ ] æ— å¯è§æ‰å¸§
```

### 6.2 åŠŸèƒ½éªŒæ”¶

- [ ] ä¸‰å±‚æ­£ç¡®åˆæˆ
- [ ] Grid å±‚åªåœ¨ Invalidate æ—¶é‡ç»˜
- [ ] çª—å£å¤§å°å˜åŒ–æ­£ç¡®å¤„ç†
- [ ] WPF é›†æˆæ­£å¸¸å·¥ä½œ

### 6.3 ç¼–è¯‘éªŒæ”¶

- [ ] `dotnet build` é€šè¿‡
- [ ] `dotnet test` å…¨éƒ¨é€šè¿‡

---

## 7. çº¦æŸï¼ˆä¸å¯è¿åï¼‰

```
âŒ ç¦æ­¢åœ¨æ¸²æŸ“å¾ªç¯ä¸­æ‰§è¡Œ O(N) è®¡ç®—
âŒ ç¦æ­¢åœ¨æ¸²æŸ“å¾ªç¯ä¸­åˆ†é…å¤§å¯¹è±¡
âŒ ç¦æ­¢ Grid å±‚æ¯å¸§é‡ç»˜ï¼ˆå¿…é¡»ç¼“å­˜ï¼‰
âœ… å¿…é¡»ç»Ÿè®¡å¹¶æ˜¾ç¤º FPS
âœ… å¿…é¡»æ­£ç¡®å¤„ç† DPI å˜åŒ–
```

---

## 8. ä¾èµ–ä¸è¢«ä¾èµ–

### ä¾èµ–
- S1-01: æ ¸å¿ƒæ¥å£å®šä¹‰
- S1-02: SafeDoubleBuffer
- S1-03: Vortice æ¸²æŸ“åº•åº§

### è¢«ä¾èµ–
- S1-05: æ¨¡æ‹Ÿæ•°æ®æºï¼ˆé›†æˆæµ‹è¯•ï¼‰
- S2-xx: æ³¢å½¢æ¸²æŸ“å™¨

---

## 9. å¯åŠ¨æŒ‡ä»¤ï¼ˆç»™ Codexï¼‰

```
è¯·å…ˆé˜…è¯»ä»¥ä¸‹æ–‡ä»¶ï¼š
1. spec/00_CONSTITUTION.mdï¼ˆé“å¾‹3ã€é“å¾‹6ï¼‰
2. spec/ARCHITECTURE.md Â§5-Â§6
3. spec/DECISIONS.md ADR-008
4. spec/ACCEPTANCE_TESTS.md AT-05
5. handoff/renderer-device-api.mdï¼ˆS1-03äº§å‡ºï¼‰
6. handoff/double-buffer-api.mdï¼ˆS1-02äº§å‡ºï¼‰

ç„¶åæ‰§è¡Œä»»åŠ¡ TASK-S1-04ï¼š
- å®ç°ä¸‰å±‚æ¸²æŸ“æ¶æ„
- å®ç° WPF é›†æˆ
- éªŒè¯ FPS â‰¥ 120
- å®Œæˆåç”Ÿæˆ handoff/renderer-api.md
```

---

**ä»»åŠ¡å¡ç»“æŸ**
