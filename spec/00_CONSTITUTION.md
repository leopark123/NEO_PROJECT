# 📜 NEO 项目宪法（Constitution）

> **版本**: v1.3  
> **状态**: 🔒 **已冻结**  
> **最后更新**: 2025-01-21  
> **作用**: 不可违反的约束，所有 AI Agent 和人类开发者必须遵守  
> **v1.3变更**: 新增数据与存储铁律（12-15条）  
> **v1.2变更**: 铁律6补充SQLite不参与实时路径约束

---

## 🚨 铁律（Iron Laws）

以下 11 条规则**绝对不可违反**。任何代码、设计、决策如果违反这些规则，必须立即停止并报告。

---

### 铁律 1：Raw 数据永不修改

```
❌ 禁止：修改、覆盖、删除已记录的原始采样数据
✅ 允许：追加新数据、创建派生视图
```

**理由**：医疗数据是法律证据，原始记录必须完整保留。

---

### 铁律 2：不伪造波形

```
❌ 禁止：跨 gap 插值、生成假的临床波形形态
❌ 禁止：用算法"补全"缺失的生理信号
✅ 允许：在 gap ≤ 4 样本（≤25ms @160Hz）时可选线性插值，但必须标记
```

**理由**：伪造的波形可能导致误诊，危及患者生命。

---

### 铁律 3：Zoom Out 必用 Min/Max 包络

```
❌ 禁止：平均值抽取、跳点抽取、随机采样
✅ 必须：每个降采样区间保留 (min, max) 对
```

**理由**：尖峰（spike）是关键临床特征，平均会导致尖峰丢失。

---

### 铁律 4：数值精度用 double

```
❌ 禁止：滤波器系数、状态变量使用 float
✅ 必须：IIR 滤波器的 a[], b[], z[] 全部使用 double (float64)
✅ 允许：渲染坐标、显示数据可用 float
```

**理由**：低频滤波器（如 0.3Hz 高通）的极点非常接近单位圆，float 精度不足会导致数值不稳定。

---

### 铁律 5：缺失/饱和必须可见

```
❌ 禁止：隐藏数据缺失、静默处理饱和
✅ 必须：
   - 数据缺失 → 波形断裂 + 灰色遮罩
   - 信号饱和 → 削顶显示 + 视觉标记
   - 电极脱落 → 明确告警
```

**理由**：临床医生必须知道数据的可信度。

---

### 铁律 6：渲染线程只 Draw

```
❌ 禁止：在渲染线程执行 O(N) 计算、分配大对象、执行 I/O
❌ 禁止：在实时渲染或 DSP 关键路径中访问 SQLite
✅ 必须：
   - 渲染线程只做 GPU 绘制调用
   - 所有计算在 DSP 线程完成
   - 数据通过无锁缓冲传递
   - SQLite 仅用于索引查询与审计日志（非实时路径）
```

**理由**：渲染卡顿会导致 UI 无响应，影响临床操作；SQLite 的锁机制可能导致不可预测延迟。

---

### 铁律 7：全链路可审计

```
✅ 必须记录：
   - 滤波器参数变更（时间、旧值、新值、操作者）
   - 显示模式切换
   - 用户标注操作
   - 异常事件（数据丢失、设备断开）
   - 系统启停
```

**理由**：医疗软件需要完整的操作追溯能力。

---

### 铁律 8：接口契约不可擅改

```
❌ 禁止：未经评审修改 ICD 定义的接口
❌ 禁止：修改 handoff/*.md 中定义的模块契约
✅ 必须：接口变更需走正式评审流程，更新所有相关文档
```

**理由**：接口是模块间的信任边界，擅改会导致系统崩溃。

---

### 铁律 9：优先级排序

```
临床安全 > DSP正确性 > 审计完整性 > 性能 > 美观
```

当目标冲突时，按此顺序决策。例如：
- 为了安全可以牺牲性能
- 为了 DSP 正确性可以牺牲美观
- 永远不能为了美观牺牲安全

---

### 铁律 10：测试先行

```
❌ 禁止：合并没有测试的代码
✅ 必须：
   - 算法代码有单元测试
   - 关键路径有集成测试
   - 验收用例可自动化执行
```

**理由**：医疗软件的质量必须可验证。

---

### 铁律 11：时间轴是一级公民

```
✅ 必须：
   - 全局使用统一时间基准：int64 微秒(μs)，单调递增
   - EEG / aEEG / NIRS / Video / UI / 审计日志 共用同一时间轴
❌ 禁止：
   - 模块使用私有时间基准
   - 用 DateTime 作为主时间轴
   - 时间戳精度不一致
```

**理由**：多模态数据必须精确同步，时间混乱会导致临床误判。

---

## 🗄️ 数据与存储铁律

### 铁律 12：Raw 数据只追加

```
❌ 禁止：UPDATE / DELETE 任何已写入的原始采样数据
✅ 必须：所有 Raw 数据表/文件采用 append-only 模式
✅ 允许：派生数据可重算覆盖，但原始数据不可变
```

**理由**：医疗数据是法律证据，必须保证完整性和可追溯性。

---

### 铁律 13：所有记录必须带时间戳

```
✅ 必须：每条数据记录包含 t_us (int64 微秒时间戳)
✅ 必须：时间戳单调递增，不可回退
❌ 禁止：无时间戳的数据记录
❌ 禁止：时间戳回退或跳变
```

**理由**：时间戳是数据对齐、回放、审计的唯一基准。

---

### 铁律 14：存储必须支持 72h+ 连续运行

```
✅ 必须：存储方案通过 72 小时连续写入压测
✅ 必须：有可验证的性能基线（写延迟、查询延迟、文件增长）
✅ 必须：存储故障不导致数据丢失（有缓冲兜底）
```

**理由**：长程监护是核心场景，存储不能成为瓶颈。

---

### 铁律 15：存储方案变更需走 ADR

```
❌ 禁止：实现阶段"顺手"更换数据库或存储方案
✅ 必须：任何存储后端变更需走 ADR 决策流程
✅ 必须：变更前评估兼容性、迁移方案、性能影响
```

**理由**：存储是系统基石，擅改会导致数据丢失或不兼容。

---

## 📋 违规处理

1. **发现违规**：立即停止当前操作
2. **报告**：向指挥官报告违规内容
3. **回滚**：撤销违规代码/操作
4. **复盘**：分析原因，更新防护措施

---

## 🔒 修改权限

本文档只能由**指挥官**修改。任何 AI Agent 不得建议、尝试、执行对本文档的修改。

---

**签署确认**

```
指挥官签名：________________
日期：2025-01-21
```
