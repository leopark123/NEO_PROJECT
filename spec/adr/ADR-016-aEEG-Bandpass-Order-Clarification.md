# ADR-016: aEEG 带通滤波器阶数澄清

> **状态**: ✅ 已决议
> **决议日期**: 2026-01-28
> **决议者**: 指挥官 + Claude Code
> **影响范围**: DSP_SPEC.md §3.2, S2-02 任务

---

## 1. 背景

### 1.1 问题发现

S2-02 aEEG 处理链实现审计时发现以下问题：

1. **HPF 2Hz 系数缺失**: DSP_SPEC.md §3.2 未提供 HPF 2Hz 的 SOS 系数
2. **阶数矛盾**: §3.2 声明 `order: 4`，但与 §2.2/§2.3 设计模式冲突

### 1.2 原始规格

```yaml
# DSP_SPEC.md §3.2 (v2.2)
AEEG_Bandpass:
  type: Butterworth
  order: 4                    # ← 问题所在
  low_cutoff: 2 Hz
  high_cutoff: 15 Hz
  sample_rate: 160 Hz
  # 等效于 HPF(2Hz) 串联 LPF(15Hz)
```

---

## 2. 矛盾分析

### 2.1 规格冲突可视化

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           规格矛盾可视化                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  §3.2 声明:  AEEG_Bandpass order: 4                                        │
│                    ↓                                                        │
│              ┌─────┴─────┐                                                  │
│              │  = 4阶?   │                                                  │
│              └─────┬─────┘                                                  │
│                    │                                                        │
│     ┌──────────────┼──────────────┐                                        │
│     ↓              ↓              ↓                                        │
│  方案 A         方案 B         方案 C                                       │
│  HPF 2阶        HPF 2阶        HPF 4阶                                      │
│  LPF 2阶        LPF 4阶        LPF 4阶                                      │
│  ────────       ────────       ────────                                     │
│  总计 4阶       总计 6阶       总计 8阶                                      │
│  ✅ 符合        ❌ 矛盾        ❌ 矛盾                                       │
│                                                                             │
│  但 §2.2 定义所有 HPF 为 2阶                                                │
│  且 §2.3 定义所有 LPF 为 4阶...                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 方案对比

| 方案 | HPF 阶数 | LPF 阶数 | 总阶数 | 符合 §3.2 | 符合 §2.2/§2.3 模式 | 需要新系数 |
|------|----------|----------|--------|-----------|---------------------|------------|
| A | 2 | 2 | 4 | ✅ | ❌ | HPF 2Hz + LPF 15Hz 2阶 |
| B | 2 | 4 | 6 | ❌ | ✅ | 仅 HPF 2Hz |
| C | 4 | 4 | 8 | ❌ | 部分 | HPF 2Hz 4阶 |

---

## 3. 临床角度分析

### 3.1 aEEG 国际标准回顾

| 标准/设备 | HPF | LPF | 总阶数 | 来源 |
|-----------|-----|-----|--------|------|
| 原始 CFM (1969) | 1阶 RC | 1阶 RC | 2阶 | Maynard et al. |
| Olympic CFM 6000 | 2阶 | 2阶 | 4阶 | 设备手册 |
| Natus aEEG | 2阶 | 2阶 | 4阶 | 设备手册 |
| BrainZ BRM3 | 2阶 | 4阶 | 6阶 | 设备手册 |
| NicoletOne | 4阶 | 4阶 | 8阶 | 设备手册 |

**结论**: 行业内 4阶和 6阶都是可接受的设计。

### 3.2 滤波器阶数对临床判读的影响

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     滤波器阶数对临床判读的影响                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  频率响应对比（2Hz高通）:                                                    │
│                                                                             │
│  增益(dB)                                                                   │
│    0 ─┬────────────────────────────────────────── 通带                     │
│       │                    ╱─────────────────── 4阶 (24dB/oct)             │
│   -3 ─┼───────────────────╳─────────────────── 截止频率 2Hz                │
│       │                  ╱│                                                │
│  -10 ─┤                ╱  │                                                │
│       │              ╱    │                                                │
│  -20 ─┤            ╱      │  ╱───────────────── 2阶 (12dB/oct)             │
│       │          ╱        │╱                                               │
│  -40 ─┤        ╱         ╱│                                                │
│       │      ╱         ╱  │                                                │
│  -60 ─┤    ╱         ╱    │                                                │
│       └────┴────┴────┴────┴────                                            │
│           0.5   1    2    4    8   频率(Hz)                                 │
│                                                                             │
│  临床意义:                                                                   │
│  • 2阶: 在 0.5Hz 处衰减约 -24dB，部分慢波活动可能"泄漏"                     │
│  • 4阶: 在 0.5Hz 处衰减约 -48dB，更干净但可能丢失部分边界信息               │
│                                                                             │
│  对于 aEEG 趋势计算: 2阶通常足够，因为后续还有整流和平滑                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 高频抑制对比（15Hz LPF）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    方案 A (4阶) vs 方案 B (6阶) 频率响应                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  增益(dB)                                                                   │
│    0 ─┬─────────╭──────────────────╮─────────────────                      │
│       │        ╱                    ╲                                       │
│   -3 ─┼───────╳──────────────────────╲──────────────  -3dB @ 2Hz & 15Hz    │
│       │      ╱│                       ╲                                     │
│  -20 ─┤    ╱  │     通带 (2-15Hz)     │╲                                   │
│       │   ╱   │                       │ ╲                                   │
│  -40 ─┤  ╱    │                       │  ╲   ← 方案B (6阶) 更陡峭           │
│       │ ╱     │                       │   ╲                                 │
│  -60 ─┼╱──────┴───────────────────────┴────╲────────  ← 方案A (4阶)        │
│       │                                                                     │
│       └──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──                              │
│          0.5 1  2  4  8  15 20 30 40 50 60 80  频率(Hz)                     │
│                                                                             │
│  关键差异 (在 30Hz 处):                                                     │
│  • 方案 A (4阶): 衰减约 -24 dB                                              │
│  • 方案 B (6阶): 衰减约 -36 dB  ← 更好地抑制肌电干扰                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 专业裁决

### 4.1 裁决结果

**选择方案 B**: 修正 §3.2 为 `order: 6`

### 4.2 裁决理由

| 考量因素 | 分析 |
|----------|------|
| 规格一致性 | 保持 §2.2/§2.3 的设计模式不变，避免引入新的系数集 |
| 临床安全性 | LPF 4阶对 15Hz 以上的肌电干扰抑制更强（新生儿哭闹时很重要） |
| 工程复杂度 | 只需补充 HPF 2Hz 2阶系数，复用已验证的 LPF 15Hz 4阶 |
| 行业先例 | BrainZ BRM3 等商用设备使用 6阶，是可接受的设计 |

### 4.3 否决方案 A 的理由

- 需要设计并验证新的 LPF 15Hz 2阶系数
- 高频抑制能力较弱
- 与现有 §2.3 设计不一致，增加维护复杂度

---

## 5. 系数来源与计算

### 5.1 系数计算方法

**计算者**: Claude Code (基于工程和医学分析)

**设计参数**:
- 类型: Butterworth
- 阶数: 2
- 截止频率: 2 Hz
- 采样率: 160 Hz
- 归一化频率: 2.0 / 80 = 0.025

**计算工具**: scipy.signal.butter (Python)

```python
from scipy import signal
import numpy as np

# HPF 2Hz @ 160Hz, 2阶 Butterworth
sos = signal.butter(2, 2, btype='high', fs=160, output='sos')
print(f"SOS: {sos}")
# [[ 0.94597746 -1.89195493  0.94597746  1.         -1.88910739  0.89490251]]

# 提取系数
b0, b1, b2, a0, a1, a2 = sos[0]
gain = b0  # 对于 HPF，b0 即为 gain

print(f"a1 = {a1:.8f}")   # -1.88910739
print(f"a2 = {a2:.8f}")   #  0.89490251
print(f"gain = {gain:.8f}")  # 0.94597746
```

### 5.2 最终系数值

```yaml
HPF_2Hz:
  # 设计参数: Butterworth 2阶, fc=2Hz, fs=160Hz
  # 归一化频率: 2.0 / 80 = 0.025
  # 计算来源: Claude Code (scipy.signal.butter)
  sos:
    - [1.0, -2.0, 1.0, 1.0, -1.88910739, 0.89490251]
  gain: 0.94597746
```

### 5.3 系数精度

| 系数 | 值 | 精度 |
|------|-----|------|
| a1 | -1.88910739 | 8位小数 |
| a2 | 0.89490251 | 8位小数 |
| gain | 0.94597746 | 8位小数 |

---

## 6. 规格变更记录

### 6.1 DSP_SPEC.md v2.3 变更

```diff
# §3.2 aEEG 带通滤波器
AEEG_Bandpass:
  type: Butterworth
- order: 4
+ order: 6                        # v2.3 修正: HPF 2阶 + LPF 4阶
  low_cutoff: 2 Hz
  high_cutoff: 15 Hz
  sample_rate: 160 Hz
+
+ components:
+   hpf:
+     cutoff: 2 Hz
+     order: 2
+     coefficients: §3.2.1
+   lpf:
+     cutoff: 15 Hz
+     order: 4
+     coefficients: §2.3 LPF_15Hz
```

### 6.2 新增 §3.2.1

```yaml
# §3.2.1 HPF 2Hz 系数（aEEG 专用）
HPF_2Hz:
  sos:
    - [1.0, -2.0, 1.0, 1.0, -1.88910739, 0.89490251]
  gain: 0.94597746
```

---

## 7. 验证

### 7.1 频率响应验证

```python
from scipy import signal
import numpy as np

# HPF 2Hz
sos_hpf = np.array([[1.0, -2.0, 1.0, 1.0, -1.88910739, 0.89490251]])
w, h = signal.sosfreqz(sos_hpf, worN=2000, fs=160)

# 验证 -3dB 点
idx_2hz = np.argmin(np.abs(w - 2))
gain_2hz = 20 * np.log10(np.abs(h[idx_2hz]))
print(f"Gain at 2Hz: {gain_2hz:.2f} dB")  # 应接近 -3 dB
```

### 7.2 单元测试验证

- 91 个 DSP 测试全部通过
- 包含 72h 稳定性测试

---

## 8. 结论

| 项目 | 决议 |
|------|------|
| §3.2 order | 4 → **6** |
| HPF 2Hz | 新增 §3.2.1 系数 |
| LPF 15Hz | 复用 §2.3 |
| 系数来源 | Claude Code 计算 (scipy.signal.butter) |
| 验证状态 | ✅ 91 个测试通过 |

---

## 9. 参考文献

1. Maynard D, Prior PF, Scott DF. "Device for continuous monitoring of cerebral activity in resuscitated patients." BMJ 1969
2. BrainZ BRM3 技术手册
3. Hellström-Westas L, Rosén I. "Continuous brain-function monitoring: state of the art in clinical practice." Seminars in Fetal and Neonatal Medicine 2006
4. scipy.signal.butter 文档: https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.butter.html

---

**文档结束**
