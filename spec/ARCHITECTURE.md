# ARCHITECTURE.md - ç³»ç»Ÿæ¶æ„è®¾è®¡

> **ç‰ˆæœ¬**: 2.5  
> **æ›´æ–°æ—¥æœŸ**: 2026-01-25  
> **å˜æ›´è¯´æ˜**: v2.5 æ–°å¢Â§8.0è®¾å¤‡æ¥å…¥ä¸æ•°æ®ç•™å­˜ï¼ˆRS232 Ingest/Parserã€USB Cameraã€StorageManageræ»šåŠ¨æ¸…ç†ï¼‰ï¼›v2.4 æ–°å¢Â§7.0è§†é¢‘è®¾å¤‡çº¦æŸï¼ˆUSBæ‘„åƒå¤´+ä¸»æœºæ—¶é—´æˆ³ï¼‰ï¼›v2.3 å®Œå–„å­˜å‚¨å±‚ï¼ˆSQLite+Chunkè¯¦ç»†çº¦æŸï¼‰ï¼›v2.2 LODæ¥å£å‚æ•°ç»Ÿä¸€ä¸ºÎ¼så•ä½ï¼›v2.1 ä¿®æ­£æ—¶é—´æˆ³å•ä½ä¸ºå¾®ç§’(Î¼s)ï¼›v2.0 æ›´æ–°ä¸º4é€šé“EEG + 6é€šé“NIRS + è§†é¢‘æ¨¡å—

---

## 1. ç³»ç»Ÿæ€»è§ˆ

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        NEO aEEG + NIRS ç›‘æŠ¤ç³»ç»Ÿ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  EEG æ¨¡å—   â”‚   â”‚  NIRS æ¨¡å—  â”‚   â”‚  è§†é¢‘æ¨¡å—   â”‚   â”‚  FDS ç®¡ç†   â”‚    â”‚
â”‚  â”‚  (4é€šé“)    â”‚   â”‚  (6é€šé“)    â”‚   â”‚  (å®æ—¶+å›æ”¾)â”‚   â”‚  (æ•°æ®å­˜å‚¨) â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                 â”‚                 â”‚                 â”‚            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â”‚
â”‚                      â”‚                 â”‚                 â”‚                 â”‚
â”‚                      â–¼                 â–¼                 â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        æ•°æ®äº¤æ¢å±‚ (æ— é”åŒç¼“å†²)                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                      â”‚                 â”‚                 â”‚                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â”‚
â”‚         â–¼            â–¼            â–¼                 â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  DSP å¤„ç†   â”‚ â”‚  aEEG ç®—æ³•  â”‚ â”‚  ä¼ªè¿¹æ£€æµ‹   â”‚ â”‚  LOD é‡‘å­—å¡” â”‚         â”‚
â”‚  â”‚  (æ»¤æ³¢é“¾)   â”‚ â”‚  (Min/Max)  â”‚ â”‚  (Gap/Clip) â”‚ â”‚  (é™é‡‡æ ·)   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚               â”‚               â”‚               â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                   â”‚                                        â”‚
â”‚                                   â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    æ¸²æŸ“å±‚ (Vortice Direct2D)                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚ Grid    â”‚  â”‚Waveform â”‚  â”‚ aEEG GS â”‚  â”‚ NIRS    â”‚  â”‚ Overlay â”‚ â”‚    â”‚
â”‚  â”‚  â”‚ (ç¼“å­˜)  â”‚  â”‚ (å®æ—¶)  â”‚  â”‚ (å¯¹æ•°è½´)â”‚  â”‚ (è¶‹åŠ¿)  â”‚  â”‚ (æ ‡æ³¨)  â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                        â”‚
â”‚                                   â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         ä¸» UI (WPF/WinUI)                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒå‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| EEG é‡‡æ ·ç‡ | 160 Hz | æ¯é€šé“ |
| EEG é€šé“æ•° | 4 | 3ç‰©ç† + 1è®¡ç®— |
| NIRS é€šé“æ•° | 6 | ç»„ç»‡æ°§é¥±å’Œåº¦ |
| æœ€å¤§ç›‘æŠ¤æ—¶é•¿ | 72 å°æ—¶ | é•¿ç¨‹ç›‘æŠ¤ |
| ç›®æ ‡å¸§ç‡ | 120 FPS | æ¸²æŸ“å±‚ |
| åˆ†è¾¨ç‡ | 1280Ã—1024 | åŸºå‡†åˆ†è¾¨ç‡ |

---

## 2. æ•°æ®é‡‡é›†å±‚

### 2.1 EEG æ•°æ®é‡‡é›†

```csharp
public interface IEegDataSource
{
    /// <summary>é‡‡æ ·ç‡: 160 Hz</summary>
    int SampleRate { get; }
    
    /// <summary>é€šé“æ•°: 4</summary>
    int ChannelCount { get; }
    
    /// <summary>é€šé“é…ç½®</summary>
    IReadOnlyList<ChannelConfig> Channels { get; }
    
    /// <summary>æ•°æ®åˆ°è¾¾äº‹ä»¶</summary>
    event EventHandler<EegDataEventArgs> DataReceived;
    
    /// <summary>å¯åŠ¨é‡‡é›†</summary>
    void Start();
    
    /// <summary>åœæ­¢é‡‡é›†</summary>
    void Stop();
}

public class ChannelConfig
{
    public int Index { get; }           // 0-3
    public string Name { get; }         // "é€šé“1", "é€šé“2", ...
    public string Montage { get; }      // "C3-P3", "C4-P4", ...
    public ChannelType Type { get; }    // Physical, Computed
}

public enum ChannelType
{
    Physical,   // ç‰©ç†é‡‡é›†é€šé“ (CH1-CH3)
    Computed    // è®¡ç®—é€šé“ (CH4 = A-D)
}
```

### 2.2 NIRS æ•°æ®é‡‡é›†

```csharp
public interface INirsDataSource
{
    /// <summary>é€šé“æ•°: 6</summary>
    int ChannelCount { get; }
    
    /// <summary>é‡‡æ ·ç‡: 1-4 Hz</summary>
    int SampleRate { get; }
    
    /// <summary>é€šé“åç§°</summary>
    IReadOnlyList<string> ChannelNames { get; }
    
    /// <summary>æ•°æ®åˆ°è¾¾äº‹ä»¶</summary>
    event EventHandler<NirsDataEventArgs> DataReceived;
}

public class NirsDataEventArgs : EventArgs
{
    public long Timestamp { get; }
    public double[] Values { get; }     // 6ä¸ªé€šé“çš„ SpO2 å€¼ (0-100%)
    public bool[] IsValid { get; }      // å„é€šé“æœ‰æ•ˆæ€§
}
```

### 2.3 è§†é¢‘æ•°æ®é‡‡é›†

```csharp
public interface IVideoSource
{
    /// <summary>è§†é¢‘åˆ†è¾¨ç‡</summary>
    Size Resolution { get; }
    
    /// <summary>å¸§ç‡</summary>
    int FrameRate { get; }
    
    /// <summary>è§†é¢‘å¸§åˆ°è¾¾äº‹ä»¶</summary>
    event EventHandler<VideoFrameEventArgs> FrameReceived;
    
    /// <summary>å½•åˆ¶çŠ¶æ€</summary>
    bool IsRecording { get; }
    
    /// <summary>å¼€å§‹å½•åˆ¶</summary>
    void StartRecording(string path);
    
    /// <summary>åœæ­¢å½•åˆ¶</summary>
    void StopRecording();
}
```

---

## 3. æ•°æ®äº¤æ¢å±‚ï¼ˆæ— é”è®¾è®¡ï¼‰

### 3.1 åŒç¼“å†²æ¶æ„

```
ç”Ÿäº§è€…çº¿ç¨‹ (é‡‡é›†)              æ¶ˆè´¹è€…çº¿ç¨‹ (æ¸²æŸ“)
      â”‚                              â”‚
      â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†™å…¥ç¼“å†²   â”‚              â”‚  è¯»å–ç¼“å†²   â”‚
â”‚  Buffer[W]  â”‚              â”‚  Buffer[R]  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                            â”‚
       â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
       â””â”€â”€â”€â”€â–ºâ”‚ å‘å¸ƒç´¢å¼•    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ (Interlocked)â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ç¯å½¢ç¼“å†²æ¥å£

```csharp
public interface IRingBuffer<T>
{
    /// <summary>å®¹é‡ (æ ·æœ¬æ•°)</summary>
    int Capacity { get; }
    
    /// <summary>å†™å…¥æ•°æ® (ç”Ÿäº§è€…è°ƒç”¨)</summary>
    void Write(ReadOnlySpan<T> data, long timestamp);
    
    /// <summary>è¯»å–æ•°æ® (æ¶ˆè´¹è€…è°ƒç”¨)</summary>
    ReadOnlySpan<T> Read(long startTimestamp, int sampleCount);
    
    /// <summary>è·å–æœ€æ–°æ—¶é—´æˆ³</summary>
    long LatestTimestamp { get; }
    
    /// <summary>è·å–æœ€æ—§æ—¶é—´æˆ³</summary>
    long OldestTimestamp { get; }
}
```

### 3.3 å¤šé€šé“æ•°æ®åŒ…

```csharp
public readonly struct EegDataPacket
{
    public long Timestamp { get; }      // å¾®ç§’æ—¶é—´æˆ³ (Î¼s)
    public double Ch1 { get; }          // é€šé“1 (Î¼V)
    public double Ch2 { get; }          // é€šé“2 (Î¼V)
    public double Ch3 { get; }          // é€šé“3 (Î¼V)
    public double Ch4 { get; }          // é€šé“4 (Î¼V) - è®¡ç®—é€šé“
    public byte QualityFlags { get; }   // è´¨é‡æ ‡å¿—
}
```

---

## 4. DSP å¤„ç†å±‚

### 4.1 æ»¤æ³¢å™¨é“¾

```csharp
public interface IFilterChain
{
    /// <summary>å¤„ç†å•ä¸ªæ ·æœ¬ (å®æ—¶æ¨¡å¼)</summary>
    double Process(double sample);
    
    /// <summary>å¤„ç†æ•°æ®å— (æ‰¹é‡æ¨¡å¼)</summary>
    void ProcessBlock(ReadOnlySpan<double> input, Span<double> output);
    
    /// <summary>é›¶ç›¸ä½å¤„ç† (å›æ”¾æ¨¡å¼)</summary>
    void ProcessZeroPhase(ReadOnlySpan<double> input, Span<double> output);
    
    /// <summary>é‡ç½®çŠ¶æ€</summary>
    void Reset();
    
    /// <summary>é¢„çƒ­å®Œæˆ</summary>
    bool IsWarmedUp { get; }
    
    /// <summary>å½“å‰è®¾ç½®</summary>
    FilterSettings Settings { get; set; }
}

public class FilterSettings
{
    public double HighpassCutoff { get; set; }  // 0.3, 0.5, 1.5 Hz
    public double LowpassCutoff { get; set; }   // 15, 35, 50, 70 Hz
    public int NotchFrequency { get; set; }     // 50, 60 Hz
}
```

### 4.2 aEEG å¤„ç†å™¨

```csharp
public interface IAeegProcessor
{
    /// <summary>å¤„ç† EEG æ•°æ®ï¼Œè¾“å‡º aEEG</summary>
    AeegOutput Process(ReadOnlySpan<double> eegData, long timestamp);
    
    /// <summary>é‡ç½®çŠ¶æ€</summary>
    void Reset();
}

public readonly struct AeegOutput
{
    public long Timestamp { get; }
    public double MinAmplitude { get; }  // ä¸‹è¾¹ç•Œ (Î¼V)
    public double MaxAmplitude { get; }  // ä¸Šè¾¹ç•Œ (Î¼V)
    public byte Quality { get; }         // è´¨é‡ç­‰çº§ 0-5
}
```

### 4.3 LOD é‡‘å­—å¡”

```csharp
public interface ILodPyramid
{
    /// <summary>å±‚çº§æ•°</summary>
    int LevelCount { get; }
    
    /// <summary>æ·»åŠ åŸå§‹æ•°æ®</summary>
    void AddSamples(ReadOnlySpan<double> samples, long timestampUs);
    
    /// <summary>è·å–æŒ‡å®šå±‚çº§çš„æ•°æ®</summary>
    ReadOnlySpan<MinMaxPair> GetLevel(int level, long startTimeUs, long endTimeUs);
    
    /// <summary>é€‰æ‹©æœ€ä½³å±‚çº§</summary>
    int SelectLevel(int viewWidthPixels, long timeRangeUs);
}

public readonly struct MinMaxPair
{
    public double Min { get; }
    public double Max { get; }
}
```

---

## 5. æ¸²æŸ“å±‚ï¼ˆä¸‰å±‚æ¶æ„ï¼‰

### 5.1 æ¸²æŸ“å±‚åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æœ€ç»ˆåˆæˆ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Layer 3: Overlay (å®æ—¶)                                        â”‚
â”‚  â”œâ”€â”€ æ—¶é—´æ¸¸æ ‡                                                   â”‚
â”‚  â”œâ”€â”€ æµ‹é‡æ ‡æ³¨                                                   â”‚
â”‚  â”œâ”€â”€ äº‹ä»¶æ ‡è®°                                                   â”‚
â”‚  â””â”€â”€ ä¼ªè¿¹é®ç½©                                                   â”‚
â”‚                                                                 â”‚
â”‚  Layer 2: Waveform (å®æ—¶)                                       â”‚
â”‚  â”œâ”€â”€ EEG æ³¢å½¢ Ã— 4é€šé“                                          â”‚
â”‚  â”œâ”€â”€ aEEG ç°åº¦å›¾ Ã— 4é€šé“                                       â”‚
â”‚  â””â”€â”€ NIRS è¶‹åŠ¿å›¾ Ã— 6é€šé“                                       â”‚
â”‚                                                                 â”‚
â”‚  Layer 1: Grid (ç¼“å­˜)                                           â”‚
â”‚  â”œâ”€â”€ èƒŒæ™¯ç½‘æ ¼                                                   â”‚
â”‚  â”œâ”€â”€ åˆ»åº¦æ ‡ç­¾                                                   â”‚
â”‚  â”œâ”€â”€ æ—¶é—´è½´                                                     â”‚
â”‚  â””â”€â”€ aEEG å½©è‰²èƒŒæ™¯åŒº                                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ¸²æŸ“å™¨æ¥å£

```csharp
public interface IWaveformRenderer : IDisposable
{
    /// <summary>åˆå§‹åŒ–æ¸²æŸ“èµ„æº</summary>
    void Initialize(IntPtr hwnd, Size size);
    
    /// <summary>è°ƒæ•´å¤§å°</summary>
    void Resize(Size newSize);
    
    /// <summary>æ¸²æŸ“ä¸€å¸§</summary>
    void RenderFrame(RenderContext context);
    
    /// <summary>å¤„ç†è®¾å¤‡ä¸¢å¤±</summary>
    void HandleDeviceLost();
    
    /// <summary>è®¾ç½® DPI</summary>
    void SetDpi(float dpi);
}

public class RenderContext
{
    public long CurrentTimestamp { get; }
    public TimeRange VisibleRange { get; }
    public ZoomLevel Zoom { get; }
    public IReadOnlyList<ChannelRenderData> Channels { get; }
}
```

### 5.3 é€šé“å¸ƒå±€

```csharp
public class ChannelLayout
{
    // EEG é€šé“ (4ä¸ª)
    public Rectangle[] EegWaveformAreas { get; }   // 4ä¸ª EEG æ³¢å½¢åŒºåŸŸ
    public Rectangle[] AeegGrayscaleAreas { get; } // 4ä¸ª aEEG ç°åº¦åŒºåŸŸ (å®é™…æ˜¾ç¤º2ä¸ª)
    
    // NIRS é€šé“ (6ä¸ªï¼Œåˆ†3ç»„æ˜¾ç¤º)
    public Rectangle[] NirsTrendAreas { get; }     // 3ä¸ª NIRS è¶‹åŠ¿åŒºåŸŸ
    
    // è§†é¢‘åŒºåŸŸ
    public Rectangle VideoArea { get; }
    
    // è®¾ç½®é¢æ¿
    public Rectangle SettingsPanel { get; }
}
```

---

## 6. ç•Œé¢å¸ƒå±€

### 6.1 ä¸»ç•Œé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â‰¡] NEO aEEG + NIRS â”‚ å†å²å›é¡¾ â”‚ â—€ 08:16:58 - 11:16:58 â–¶ â”‚ ğŸ• â”‚ åºŠä½å·: 41â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                    â”‚ â”‚ å¯¼è”: [é€šé“1 â–¼] â”‚ â”‚           â”‚ â”‚
â”‚  â”‚         aEEG é€šé“1 (3å°æ—¶)         â”‚ â”‚ å¢ç›Š: [100Î¼V â–¼] â”‚ â”‚           â”‚ â”‚
â”‚  â”‚         (å¯¹æ•°Yè½´: 0-200Î¼V)         â”‚ â”‚ èŒƒå›´: [200Î¼V â–¼] â”‚ â”‚  å®æ—¶è§†é¢‘ â”‚ â”‚
â”‚  â”‚                                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚           â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚           â”‚ â”‚
â”‚  â”‚  â—€â—€ â”‚      EEG æ³¢å½¢1 (15ç§’)      â”‚ â–¶â–¶                   â”‚           â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚                                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚         aEEG é€šé“2 (3å°æ—¶)         â”‚ â”‚ å¯¼è”: [é€šé“2 â–¼] â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         (å¯¹æ•°Yè½´: 0-200Î¼V)         â”‚ â”‚ å¢ç›Š: [100Î¼V â–¼] â”‚ â”‚ ç»„ç»‡æ°§1   â”‚ â”‚
â”‚  â”‚                                    â”‚ â”‚ èŒƒå›´: [200Î¼V â–¼] â”‚ â”‚   --%     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  â—€â—€ â”‚      EEG æ³¢å½¢2 (15ç§’)      â”‚ â–¶â–¶                   â”‚ ç»„ç»‡æ°§2   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   --%     â”‚ â”‚
â”‚                                                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ ç»„ç»‡æ°§3   â”‚ â”‚
â”‚  â”‚               â”‚               â”‚               â”‚          â”‚   --%     â”‚ â”‚
â”‚  â”‚  NIRS è¶‹åŠ¿1  â”‚  NIRS è¶‹åŠ¿2  â”‚  NIRS è¶‹åŠ¿3  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚               â”‚               â”‚               â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å›é¡¾é¦–é¡µ] [å†å²å›é¡¾] [æ˜¾ç¤ºè®¾ç½®] [æ»¤æ³¢è®¾ç½®] [ç”¨æˆ·ç®¡ç†] [æ•°æ®å¯¼å‡º]     [å…³æœº] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 aEEG æ˜¾ç¤ºå‚æ•°

```yaml
aeeg_display:
  y_axis_type: logarithmic       # å¯¹æ•°åˆ»åº¦
  y_range: [0, 200]              # Î¼V
  y_ticks: [0, 5, 10, 25, 50, 100, 200]
  time_range: 3 hours
  
  background_zones:              # å½©è‰²èƒŒæ™¯åŒºåŸŸ
    abnormal: 
      range: [0, 5]
      color: "#FF0000"           # çº¢è‰²
    borderline:
      range: [5, 10]
      color: "#FFFF00"           # é»„è‰²
    normal:
      range: [10, 25]
      color: "#00FF00"           # ç»¿è‰²
    burst:
      range: [25, 200]
      color: "#FFFFFF"           # ç™½è‰²
```

### 6.3 EEG æ˜¾ç¤ºå‚æ•°

```yaml
eeg_display:
  y_axis_type: linear
  y_range_options: [Â±25, Â±50, Â±100, Â±200]  # Î¼V
  default_y_range: Â±50
  time_range_options: [7, 14, 20]           # ç§’
  default_time_range: 15
  
  gain_options: [25, 50, 100, 200]          # Î¼V/cm
```

---

## 7. è§†é¢‘æ¨¡å—

### 7.0 è§†é¢‘è®¾å¤‡çº¦æŸï¼ˆå·²ç¡®è®¤ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è§†é¢‘è®¾å¤‡äº‹å®ï¼ˆå†»ç»“ï¼‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®¾å¤‡ç±»å‹    â”‚  é€šç”¨ USB æ‘„åƒå¤´ (UVC)                            â”‚
â”‚  SDK/é©±åŠ¨    â”‚  æ— ä¸“ç”¨ SDKï¼Œä½¿ç”¨ç³»ç»Ÿ UVC é©±åŠ¨                    â”‚
â”‚  ç¡¬ä»¶åŒæ­¥    â”‚  æ—  Genlockã€æ—  PTPã€æ— ç¡¬ä»¶è§¦å‘                   â”‚
â”‚  æ—¶é—´æˆ³æ¥æº  â”‚  ä¸»æœº Monotonic Clockï¼ˆå¸§é‡‡é›†æ—¶æ‰“æˆ³ï¼‰             â”‚
â”‚  åŒæ­¥ç²¾åº¦    â”‚  æ¯«ç§’çº§ (Â±50-100ms)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Video Adapter è®¾è®¡åŸåˆ™**ï¼š

```csharp
/// <summary>
/// æœ€å° Video Adapter - ä¸ä¾èµ–è®¾å¤‡æ—¶é—´æˆ³
/// </summary>
public class UvcVideoAdapter : IVideoSource
{
    // å…³é”®ï¼šä½¿ç”¨ä¸ EEG ç›¸åŒçš„ HostClock
    public void OnFrameCaptured(byte[] frameData)
    {
        // âŒ ä¸ä½¿ç”¨ï¼šframe.DeviceTimestampï¼ˆä¸å¯é æˆ–ä¸å­˜åœ¨ï¼‰
        // âœ… ä½¿ç”¨ï¼šä¸»æœºå•è°ƒæ—¶é’Ÿ
        long timestampUs = HostClock.NowMicroseconds();
        
        var frame = new VideoFrame
        {
            TimestampUs = timestampUs,
            Data = frameData,
            ClockDomain = ClockDomain.Host  // æ˜ç¡®æ ‡è®°æ—¶é’ŸåŸŸ
        };
        
        FrameReceived?.Invoke(this, new VideoFrameEventArgs(frame));
    }
}
```

**ä¸ EEG åŒæ­¥ç­–ç•¥**ï¼š

| æ•°æ®æº | æ—¶é—´æˆ³æ¥æº | æ—¶é’ŸåŸŸ | é¢„ä¼°ç²¾åº¦ |
|--------|-----------|--------|----------|
| EEG | HostClock.NowMicroseconds() | Host | Â±10-15ms |
| Video | HostClock.NowMicroseconds() | Host | Â±50-100ms |

> ğŸ’¡ **åŒæ­¥åŸç†**ï¼šEEG å’Œ Video ä½¿ç”¨åŒä¸€ä¸ªä¸»æœºæ—¶é’Ÿæºï¼Œé€šè¿‡å…±äº«æ—¶é—´åŸºå‡†å®ç°è½¯ä»¶å¯¹é½ã€‚
> ç²¾åº¦è¶³ä»¥æ»¡è¶³"è§‚å¯Ÿæ‚£è€…è¡Œä¸ºä¸è„‘ç”µå˜åŒ–çš„å¯¹åº”å…³ç³»"çš„ä¸´åºŠéœ€æ±‚ã€‚

### 7.1 è§†é¢‘ç®¡ç†å™¨

```csharp
public interface IVideoManager
{
    /// <summary>è§†é¢‘æº</summary>
    IVideoSource Source { get; }
    
    /// <summary>å®æ—¶è§†é¢‘å¸§ (ç”¨äºæ˜¾ç¤º)</summary>
    BitmapSource CurrentFrame { get; }
    
    /// <summary>å½•åˆ¶çŠ¶æ€</summary>
    RecordingState State { get; }
    
    /// <summary>å¼€å§‹å½•åˆ¶</summary>
    void StartRecording();
    
    /// <summary>åœæ­¢å½•åˆ¶</summary>
    void StopRecording();
    
    /// <summary>åŒæ­¥å›æ”¾ (ä¸EEGæ—¶é—´è½´åŒæ­¥)</summary>
    void SeekTo(long timestamp);
    
    /// <summary>è·å–æŒ‡å®šæ—¶é—´ç‚¹çš„è§†é¢‘å¸§</summary>
    BitmapSource GetFrameAt(long timestamp);
}

public enum RecordingState
{
    Idle,
    Recording,
    Paused,
    Error
}
```

### 7.2 è§†é¢‘å­˜å‚¨

```yaml
video_storage:
  format: H.264/MP4
  resolution: 640x480          # å¯é…ç½®
  framerate: 15-30 fps
  bitrate: 1-2 Mbps
  
  sync:
    method: timestamp_index    # æ—¶é—´æˆ³ç´¢å¼•æ–‡ä»¶
    precision: 33ms            # å¸§çº§ç²¾åº¦
```

---

## 8. æ•°æ®å­˜å‚¨å±‚

### 8.1 å­˜å‚¨æ–¹æ¡ˆé€‰å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å­˜å‚¨æ–¹æ¡ˆï¼šSQLite + Chunk                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€‰æ‹©ç†ç”±ï¼š                                                      â”‚
â”‚  âœ… é›¶éƒ¨ç½²ä¾èµ–ï¼ˆåµŒå…¥å¼ï¼Œæ— éœ€å®‰è£…æ•°æ®åº“æœåŠ¡ï¼‰                      â”‚
â”‚  âœ… åŒ»ç–—è®¾å¤‡ç¦»çº¿è¿è¡Œå‹å¥½                                         â”‚
â”‚  âœ… å•æ–‡ä»¶å¤‡ä»½/è¿ç§»ç®€å•                                          â”‚
â”‚  âœ… ACID äº‹åŠ¡ä¿è¯æ•°æ®å®Œæ•´æ€§                                      â”‚
â”‚  âœ… æˆç†Ÿç¨³å®šï¼ŒåŒ»ç–—è¡Œä¸šå¹¿æ³›ä½¿ç”¨                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‡çº§è§¦å‘æ¡ä»¶ï¼ˆæ»¡è¶³ä»»ä¸€åˆ™è¯„ä¼°å‡çº§åˆ° PostgreSQL/TimescaleDBï¼‰ï¼š   â”‚
â”‚  âš ï¸ éœ€è¦å¤šå®¢æˆ·ç«¯å¹¶å‘å†™å…¥ï¼ˆ>1 å†™å…¥æºï¼‰                           â”‚
â”‚  âš ï¸ éœ€è¦ç½‘ç»œå…±äº«/ä¸­å¿ƒåŒ–æ•°æ®æœåŠ¡                                 â”‚
â”‚  âš ï¸ æ•°æ®ç•™å­˜ä» 72h æå‡åˆ°æ•°æœˆ/æ•°å¹´ä¸”é¢‘ç¹æ£€ç´¢                    â”‚
â”‚  âš ï¸ éœ€è¦å¤æ‚èšåˆåˆ†æï¼ˆè·¨æ‚£è€…/è·¨è®¾å¤‡ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 SQLite è¿è¡Œæ—¶é…ç½®ï¼ˆå¼ºåˆ¶ï¼‰

```yaml
sqlite_config:
  # WAL æ¨¡å¼ï¼ˆå¿…é¡»å¼€å¯ï¼‰
  journal_mode: WAL
  
  # åŒæ­¥çº§åˆ«ï¼ˆå¹³è¡¡å®‰å…¨ä¸æ€§èƒ½ï¼‰
  synchronous: NORMAL
  
  # å¿™ç­‰å¾…è¶…æ—¶
  busy_timeout: 5000  # ms
  
  # WAL æ£€æŸ¥ç‚¹ç­–ç•¥
  wal_autocheckpoint: 1000  # æ¯1000é¡µè‡ªåŠ¨checkpoint
  wal_checkpoint_interval: 60  # ç§’ï¼Œå®šæ—¶checkpoint
  
  # ç¼“å­˜é…ç½®
  cache_size: -64000  # 64MBï¼ˆè´Ÿæ•°è¡¨ç¤ºKBï¼‰
  
  # ä¸´æ—¶å­˜å‚¨
  temp_store: MEMORY
  
  # å¤–é”®çº¦æŸ
  foreign_keys: ON
```

### 8.3 è¯»å†™åˆ†ç¦»ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è¿æ¥ç®¡ç†                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  å†™å…¥è¿æ¥ï¼ˆå•ä¸€ï¼‰                    è¯»å–è¿æ¥ï¼ˆå¤šä¸ªï¼‰            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ DSP çº¿ç¨‹    â”‚                    â”‚ UI æŸ¥è¯¢    â”‚            â”‚
â”‚  â”‚ æ‰¹é‡å†™å…¥    â”‚                    â”‚ åªè¯»æ¨¡å¼   â”‚            â”‚
â”‚  â”‚ å›ºå®šå‘¨æœŸ    â”‚                    â”‚ ä¸é˜»å¡å†™å…¥ â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                                  â”‚                    â”‚
â”‚         â–¼                                  â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SQLite WAL                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  å†™å…¥ç­–ç•¥ï¼š                         è¯»å–ç­–ç•¥ï¼š                   â”‚
â”‚  - å•å†™çº¿ç¨‹ï¼ˆé¿å…é”ç«äº‰ï¼‰           - åªè¯»è¿æ¥                   â”‚
â”‚  - æ‰¹é‡äº‹åŠ¡ï¼ˆ100-500æ ·æœ¬/æ‰¹ï¼‰       - æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢             â”‚
â”‚  - å›ºå®šæäº¤å‘¨æœŸï¼ˆ100-500msï¼‰        - åˆ©ç”¨ç´¢å¼•                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.4 Chunk åˆ†æ®µç­–ç•¥

```yaml
chunk_strategy:
  # åˆ†æ®µæ–¹æ¡ˆï¼šå¤šæ–‡ä»¶ï¼ˆæ¯å°æ—¶ä¸€ä¸ª db æ–‡ä»¶ï¼‰
  method: multi_file
  
  # åˆ†æ®µç²’åº¦
  granularity: 1 hour
  
  # æ–‡ä»¶å‘½å
  pattern: "eeg_{patient_id}_{YYYYMMDD_HH}.db"
  
  # æ´»è·ƒæ–‡ä»¶
  active_files: 2  # å½“å‰å°æ—¶ + ä¸Šä¸€å°æ—¶
  
  # æ»šåŠ¨ç­–ç•¥
  retention:
    raw_data: 72 hours      # Raw æ•°æ®ä¿ç•™72å°æ—¶
    audit_log: 365 days     # å®¡è®¡æ—¥å¿—ä¿ç•™1å¹´
    derived_data: 72 hours  # æ´¾ç”Ÿæ•°æ®è·ŸéšRaw
  
  # æ¸…ç†ç­–ç•¥
  cleanup:
    method: archive_then_delete  # å…ˆå½’æ¡£å†åˆ é™¤
    archive_path: "/archive/{patient_id}/"
    verify_before_delete: true   # åˆ é™¤å‰æ ¡éªŒå½’æ¡£å®Œæ•´æ€§
```

### 8.5 æ•°æ®æ¨¡å‹åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®åˆ†ç±»å­˜å‚¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Raw æ•°æ®      â”‚  â”‚  Derived æ•°æ®   â”‚  â”‚   Audit æ—¥å¿—    â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ - EEG åŸå§‹æ ·æœ¬  â”‚  â”‚ - aEEG è®¡ç®—ç»“æœ â”‚  â”‚ - å‚æ•°å˜æ›´      â”‚ â”‚
â”‚  â”‚ - NIRS åŸå§‹æ ·æœ¬ â”‚  â”‚ - LOD é‡‘å­—å¡”    â”‚  â”‚ - æ“ä½œè®°å½•      â”‚ â”‚
â”‚  â”‚ - è§†é¢‘å¸§ç´¢å¼•    â”‚  â”‚ - ä¼ªè¿¹æ ‡è®°      â”‚  â”‚ - å¼‚å¸¸äº‹ä»¶      â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚ - ç³»ç»Ÿå¯åœ      â”‚ â”‚
â”‚  â”‚ ã€åªè¿½åŠ ã€‘      â”‚  â”‚ ã€å¯é‡ç®—è¦†ç›–ã€‘  â”‚  â”‚ ã€åªè¿½åŠ ã€‘      â”‚ â”‚
â”‚  â”‚ ã€ä¸å¯åˆ é™¤ã€‘    â”‚  â”‚ ã€å¯æ¸…ç†ã€‘      â”‚  â”‚ ã€é•¿æœŸä¿ç•™ã€‘    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.6 æ€§èƒ½åŸºçº¿ï¼ˆå¿…é¡»è¾¾æ ‡ï¼‰

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|----------|
| å†™å…¥å»¶è¿Ÿ P99 | < 50 ms/æ‰¹ | æ‰¹é‡å†™å…¥è®¡æ—¶ |
| æŸ¥è¯¢å»¶è¿Ÿï¼ˆ1å°æ—¶èŒƒå›´ï¼‰ | < 100 ms | æ—¶é—´èŒƒå›´æŸ¥è¯¢ |
| æŸ¥è¯¢å»¶è¿Ÿï¼ˆå…¨ç¨‹72hï¼‰ | < 500 ms | LOD æŸ¥è¯¢ |
| 72h è¿ç»­å†™å…¥ | é›¶å¤±è´¥ | å‹æµ‹ |
| æ–‡ä»¶å¢é•¿ï¼ˆæ¯å°æ—¶ï¼‰ | < 50 MB | ç›‘æ§ |
| Checkpoint é˜»å¡æ—¶é—´ | < 100 ms | WAL ç›‘æ§ |

### 8.7 è¡¨ç»“æ„å®šä¹‰

```sql
-- Raw EEG æ•°æ®è¡¨ï¼ˆæ¯å°æ—¶åˆ†æ–‡ä»¶ï¼‰
CREATE TABLE eeg_raw (
    id INTEGER PRIMARY KEY,
    t_us INTEGER NOT NULL,           -- å¾®ç§’æ—¶é—´æˆ³
    ch1 REAL NOT NULL,               -- é€šé“1 (Î¼V)
    ch2 REAL NOT NULL,               -- é€šé“2 (Î¼V)
    ch3 REAL NOT NULL,               -- é€šé“3 (Î¼V)
    ch4 REAL NOT NULL,               -- é€šé“4 (Î¼V)
    quality_flags INTEGER DEFAULT 0  -- è´¨é‡æ ‡å¿—
);
CREATE INDEX idx_eeg_raw_t ON eeg_raw(t_us);

-- aEEG æ´¾ç”Ÿæ•°æ®è¡¨
CREATE TABLE aeeg_derived (
    id INTEGER PRIMARY KEY,
    t_us INTEGER NOT NULL,           -- å¾®ç§’æ—¶é—´æˆ³ï¼ˆçª—å£ä¸­å¿ƒï¼‰
    channel INTEGER NOT NULL,        -- é€šé“å· 0-3
    min_uv REAL NOT NULL,            -- ä¸‹è¾¹ç•Œ (Î¼V)
    max_uv REAL NOT NULL,            -- ä¸Šè¾¹ç•Œ (Î¼V)
    quality INTEGER DEFAULT 0        -- è´¨é‡ç­‰çº§
);
CREATE INDEX idx_aeeg_t_ch ON aeeg_derived(t_us, channel);

-- NIRS æ•°æ®è¡¨
CREATE TABLE nirs_raw (
    id INTEGER PRIMARY KEY,
    t_us INTEGER NOT NULL,
    ch1 REAL, ch2 REAL, ch3 REAL,
    ch4 REAL, ch5 REAL, ch6 REAL,
    valid_mask INTEGER DEFAULT 63    -- ä½æ©ç ï¼šå“ªäº›é€šé“æœ‰æ•ˆ
);
CREATE INDEX idx_nirs_t ON nirs_raw(t_us);

-- å®¡è®¡æ—¥å¿—è¡¨ï¼ˆç‹¬ç«‹æ–‡ä»¶ï¼Œé•¿æœŸä¿ç•™ï¼‰
CREATE TABLE audit_log (
    id INTEGER PRIMARY KEY,
    t_us INTEGER NOT NULL,
    event_type TEXT NOT NULL,        -- 'FILTER_CHANGE', 'MODE_SWITCH', etc.
    old_value TEXT,
    new_value TEXT,
    operator TEXT,
    details TEXT                     -- JSON æ ¼å¼æ‰©å±•ä¿¡æ¯
);
CREATE INDEX idx_audit_t ON audit_log(t_us);
CREATE INDEX idx_audit_type ON audit_log(event_type);
```

### 8.8 æ•…éšœæ¢å¤ç­–ç•¥

```yaml
fault_tolerance:
  # å†™å…¥ç¼“å†²ï¼ˆSQLite ä¸å¯ç”¨æ—¶çš„å…œåº•ï¼‰
  memory_buffer:
    enabled: true
    duration: 5 minutes              # æœ€å¤šç¼“å†²5åˆ†é’Ÿæ•°æ®
    flush_on_recovery: true          # æ¢å¤åç«‹å³å†™å…¥
  
  # æ–‡ä»¶æŸåæ£€æµ‹
  integrity_check:
    on_startup: true                 # å¯åŠ¨æ—¶æ£€æŸ¥
    periodic: 1 hour                 # å®šæœŸæ£€æŸ¥
    action_on_corruption: 
      - notify_user
      - switch_to_new_chunk
      - preserve_corrupted_file
  
  # WAL æ¢å¤
  wal_recovery:
    auto_recover: true
    max_wal_size: 100 MB             # è¶…è¿‡åˆ™å¼ºåˆ¶checkpoint
```

### 8.9 å­˜å‚¨æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å­˜å‚¨å±‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  EEG æ•°æ®   â”‚  â”‚  aEEG æ•°æ®  â”‚  â”‚  NIRS æ•°æ®  â”‚            â”‚
â”‚  â”‚  (EDF+/äºŒè¿›åˆ¶)â”‚  â”‚  (äºŒè¿›åˆ¶)   â”‚  â”‚  (äºŒè¿›åˆ¶)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  è§†é¢‘æ–‡ä»¶   â”‚  â”‚  æˆªå›¾/æ ‡æ³¨  â”‚  â”‚  å®¡è®¡æ—¥å¿—   â”‚            â”‚
â”‚  â”‚  (MP4)      â”‚  â”‚  (PNG/JSON) â”‚  â”‚  (SQLite)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ç´¢å¼•æ•°æ®åº“ (SQLite)                    â”‚  â”‚
â”‚  â”‚  - æ‚£è€…ä¿¡æ¯                                              â”‚  â”‚
â”‚  â”‚  - ç›‘æµ‹ä¼šè¯                                              â”‚  â”‚
â”‚  â”‚  - äº‹ä»¶/æ ‡æ³¨                                             â”‚  â”‚
â”‚  â”‚  - æ—¶é—´æˆ³ç´¢å¼•                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æ–‡ä»¶ç»„ç»‡

```
/data/patients/{patient_id}/
â”œâ”€â”€ session_{timestamp}/
â”‚   â”œâ”€â”€ eeg/
â”‚   â”‚   â”œâ”€â”€ raw_ch1.edf         # é€šé“1åŸå§‹æ•°æ®
â”‚   â”‚   â”œâ”€â”€ raw_ch2.edf         # é€šé“2åŸå§‹æ•°æ®
â”‚   â”‚   â”œâ”€â”€ raw_ch3.edf         # é€šé“3åŸå§‹æ•°æ®
â”‚   â”‚   â””â”€â”€ raw_ch4.edf         # é€šé“4åŸå§‹æ•°æ®
â”‚   â”œâ”€â”€ aeeg/
â”‚   â”‚   â”œâ”€â”€ aeeg_ch1.bin        # aEEGæ•°æ®
â”‚   â”‚   â””â”€â”€ aeeg_ch2.bin
â”‚   â”œâ”€â”€ nirs/
â”‚   â”‚   â””â”€â”€ nirs_6ch.bin        # NIRS 6é€šé“æ•°æ®
â”‚   â”œâ”€â”€ video/
â”‚   â”‚   â”œâ”€â”€ video.mp4           # è§†é¢‘æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ video_index.json    # æ—¶é—´æˆ³ç´¢å¼•
â”‚   â”œâ”€â”€ events/
â”‚   â”‚   â”œâ”€â”€ events.json         # äº‹ä»¶åˆ—è¡¨
â”‚   â”‚   â””â”€â”€ screenshots/        # æˆªå›¾ç›®å½•
â”‚   â””â”€â”€ metadata.json           # ä¼šè¯å…ƒæ•°æ®
â””â”€â”€ patient_info.json           # æ‚£è€…ä¿¡æ¯
```

---

## 9. æ—¶é—´è½´ç³»ç»Ÿ

### 9.1 ç»Ÿä¸€æ—¶é—´åŸºå‡†

```csharp
public interface ITimelineService
{
    /// <summary>å½“å‰æ’­æ”¾ä½ç½® (å¾®ç§’)</summary>
    long CurrentPosition { get; }
    
    /// <summary>ä¼šè¯å¼€å§‹æ—¶é—´ (UTC)</summary>
    DateTimeOffset SessionStart { get; }
    
    /// <summary>æ’­æ”¾çŠ¶æ€</summary>
    PlaybackState State { get; }
    
    /// <summary>æ’­æ”¾é€Ÿåº¦ (1.0 = å®æ—¶)</summary>
    double PlaybackRate { get; set; }
    
    /// <summary>è·³è½¬åˆ°æŒ‡å®šä½ç½® (å¾®ç§’)</summary>
    void SeekTo(long positionUs);
    
    /// <summary>ä½ç½®å˜åŒ–äº‹ä»¶</summary>
    event EventHandler<TimelinePositionEventArgs> PositionChanged;
}

public enum PlaybackState
{
    Live,       // å®æ—¶ç›‘æµ‹
    Playing,    // å›æ”¾ä¸­
    Paused,     // æš‚åœ
    Seeking     // è·³è½¬ä¸­
}
```

### 9.2 æ—¶é—´æˆ³æ ¼å¼

```yaml
timestamp:
  type: int64
  unit: microseconds              # å¾®ç§’
  epoch: session_start            # ç›¸å¯¹äºä¼šè¯å¼€å§‹æ—¶é—´
  utc_offset: stored_separately
```

---

## 10. æ¨¡å—é€šä¿¡

### 10.1 è¿›ç¨‹é—´é€šä¿¡

```yaml
ipc:
  # UI â†” FDS Manager
  ui_fds:
    method: named_pipe
    name: "cerebraline_fds"
    
  # UI â†” Video Manager  
  ui_video:
    method: named_pipe
    name: "cerebraline_video"
    
  # å†…éƒ¨æ¨¡å—
  internal:
    method: windows_messages
```

### 10.2 æ¶ˆæ¯å®šä¹‰

```csharp
public enum MessageType
{
    // æ•°æ®æ¶ˆæ¯
    EegData,
    NirsData,
    VideoFrame,
    
    // æ§åˆ¶æ¶ˆæ¯
    StartMonitoring,
    StopMonitoring,
    ChangeFilter,
    
    // çŠ¶æ€æ¶ˆæ¯
    DeviceStatus,
    AlarmTriggered,
    RecordingStatus
}
```

---

## 11. é”™è¯¯å¤„ç†

### 11.1 è®¾å¤‡ä¸¢å¤±æ¢å¤

```csharp
public interface IDeviceLostHandler
{
    /// <summary>æ£€æµ‹è®¾å¤‡çŠ¶æ€</summary>
    DeviceState CheckDeviceState();
    
    /// <summary>å°è¯•æ¢å¤è®¾å¤‡</summary>
    Task<bool> TryRecoverAsync();
    
    /// <summary>è®¾å¤‡ä¸¢å¤±äº‹ä»¶</summary>
    event EventHandler<DeviceLostEventArgs> DeviceLost;
    
    /// <summary>è®¾å¤‡æ¢å¤äº‹ä»¶</summary>
    event EventHandler DeviceRecovered;
}
```

### 11.2 æ•°æ®è¿ç»­æ€§ä¿æŠ¤

```yaml
data_protection:
  # é‡‡é›†ä¸­æ–­
  acquisition_gap:
    detection: packet_sequence_check
    recovery: reconnect_with_gap_marker
    
  # å­˜å‚¨æ•…éšœ
  storage_failure:
    detection: write_verification
    recovery: fallback_to_memory_buffer
    buffer_duration: 5 minutes
```

---

## 12. æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|---------|
| æ¸²æŸ“å¸§ç‡ | â‰¥120 FPS | å¸§è®¡æ—¶å™¨ |
| æ¸²æŸ“å»¶è¿Ÿ | <8.3 ms | å¸§æ—¶é—´æµ‹é‡ |
| æ•°æ®å»¶è¿Ÿ | <50 ms | ç«¯åˆ°ç«¯æµ‹é‡ |
| CPU å ç”¨ | <30% | ä»»åŠ¡ç®¡ç†å™¨ |
| å†…å­˜å ç”¨ | <500 MB | è¿›ç¨‹ç›‘æ§ |
| 72h ç¨³å®šæ€§ | æ— å´©æºƒ | é•¿æ—¶é—´è¿è¡Œæµ‹è¯• |

---

## 13. è®¾å¤‡æ¥å…¥ä¸æ•°æ®ç•™å­˜ï¼ˆv1.2 æ–°å¢ï¼‰

### 13.1 è®¾å¤‡æ¥å…¥æ¨¡å—èŒè´£

| æ¨¡å— | èŒè´£ | è¾“å‡º |
|------|------|------|
| RS232 Ingest | ä¸²å£æ•°æ®æ¥æ”¶ | åŸå§‹å­—èŠ‚æµ |
| EEG Parser | EEG åè®®è§£æ + ä¸»æœºæ‰“ç‚¹ | å¸¦æ—¶é—´æˆ³çš„ EEG æ ·æœ¬ |
| NIRS Parser | NIRS åè®®è§£æ + ä¸»æœºæ‰“ç‚¹ | å¸¦æ—¶é—´æˆ³çš„ NIRS æ ·æœ¬ |
| USB Camera Capture | è§†é¢‘å¸§é‡‡é›† + ä¸»æœºæ‰“ç‚¹ | å¸¦æ—¶é—´æˆ³çš„è§†é¢‘å¸§ |
| StorageManager | å­˜å‚¨ç®¡ç† + æ»šåŠ¨æ¸…ç† | æŒä¹…åŒ–æ•°æ® |

### 13.2 RS232 Ingest æ¨¡å—

```csharp
public class Rs232Ingest : IDisposable
{
    private SerialPort _port;
    private byte[] _buffer;
    
    public event Action<byte[], long> DataReceived;
    
    private void OnDataReceived(object sender, SerialDataReceivedEventArgs e)
    {
        // ä¸»æœºæ‰“ç‚¹ï¼šæ•°æ®åˆ°è¾¾æ—¶ç«‹å³æ‰“æˆ³
        long timestampUs = Stopwatch.GetTimestamp() * 1_000_000 / Stopwatch.Frequency;
        
        int bytesRead = _port.Read(_buffer, 0, _port.BytesToRead);
        DataReceived?.Invoke(_buffer[..bytesRead], timestampUs);
    }
}
```

### 13.3 USB Camera Capture æ¨¡å—

```csharp
public class UsbCameraCapture : IVideoSource
{
    // UVCåè®®ï¼Œå³æ’å³ç”¨ï¼Œæ— ä¸“ç”¨SDK
    public event Action<VideoFrame, long> FrameCaptured;
    
    private void OnFrameArrived(VideoFrame frame)
    {
        // ä¸»æœºæ‰“ç‚¹ï¼ˆéè®¾å¤‡PTSï¼‰
        long timestampUs = Stopwatch.GetTimestamp() * 1_000_000 / Stopwatch.Frequency;
        FrameCaptured?.Invoke(frame, timestampUs);
    }
}
```

### 13.4 StorageManager æ»šåŠ¨æ¸…ç†

```csharp
public class StorageManager
{
    private const long MaxStorageBytes = 300L * 1024 * 1024 * 1024; // 300 GiB
    
    /// <summary>
    /// æ£€æŸ¥å­˜å‚¨å¹¶åœ¨éœ€è¦æ—¶æ‰§è¡Œæ»šåŠ¨æ¸…ç†
    /// </summary>
    public void CheckAndCleanup()
    {
        while (GetCurrentStorageSize() > MaxStorageBytes * 0.9)
        {
            var oldestSession = GetOldestNonActiveSession();
            if (oldestSession != null)
            {
                // æŒ‰æ‚£è€…ä¼šè¯æ•´ä½“åˆ é™¤
                DeletePatientSession(oldestSession);
                LogAudit($"Deleted session: {oldestSession.Id}");
            }
            else
            {
                // åªå‰©å½“å‰æ´»è·ƒä¼šè¯ï¼Œä¸å¯åˆ é™¤
                break;
            }
        }
    }
    
    /// <summary>
    /// è·å–éæ´»è·ƒçš„æœ€æ—§æ‚£è€…ä¼šè¯
    /// </summary>
    private PatientSession GetOldestNonActiveSession()
    {
        return _sessions
            .Where(s => !s.IsActive)
            .OrderBy(s => s.StartTime)
            .FirstOrDefault();
    }
}
```

### 13.5 å­˜å‚¨ç­–ç•¥çº¦æŸï¼ˆADR-014ï¼‰

| çº¦æŸé¡¹ | è§„æ ¼ |
|--------|------|
| å­˜å‚¨ä¸Šé™ | 300 GiBï¼ˆå¯é…ç½®ï¼‰ |
| åˆ é™¤ç²’åº¦ | æŒ‰æ‚£è€…ä¼šè¯æ•´ä½“åˆ é™¤ |
| åˆ é™¤ä¿æŠ¤ | å½“å‰æ´»è·ƒç›‘æŠ¤ä¸å¯åˆ é™¤ |
| ç›‘æŠ¤è¿ç»­æ€§ | æ¸…ç†è¿‡ç¨‹ä¸ä¸­æ–­å½“å‰ç›‘æŠ¤ |
| æ¸…ç†è§¦å‘ | å­˜å‚¨ä½¿ç”¨ç‡ > 90% |
| å®¡è®¡è¦æ±‚ | åˆ é™¤æ“ä½œå¿…é¡»è®°å½•æ—¥å¿— |

---

**æ–‡æ¡£ç»“æŸ**
