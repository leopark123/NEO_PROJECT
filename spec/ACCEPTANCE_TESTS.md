# ACCEPTANCE_TESTS.md - 验收测试用例

> **版本**: 2.1  
> **更新日期**: 2026-01-25  
> **变更说明**: v2.1 新增AT-23(增益档位)、AT-24(存储滚动清理)、AT-25(aEEG医学合规)、AT-26(NIRS职责边界)；v2.0 基于 160Hz/4通道 参数更新测试用例

---

## 测试用例索引

| ID | 类别 | 标题 | Sprint |
|----|------|------|--------|
| AT-01 | 数据采集 | EEG 数据包解析 | S1 |
| AT-02 | 数据采集 | NIRS 数据接收 | S3 |
| AT-03 | 数据交换 | 无锁缓冲吞吐量 | S1 |
| AT-04 | 数据交换 | 生产者-消费者同步 | S1 |
| AT-05 | 渲染 | 120 FPS 稳定性 | S1 |
| AT-06 | 渲染 | 4通道波形正确性 | S1 |
| AT-07 | 渲染 | DPI 切换 | S1 |
| AT-08 | 渲染 | DeviceLost 恢复 | S1 |
| AT-09 | DSP | 滤波器频率响应 | S2 |
| AT-10 | DSP | 滤波器稳定性 | S2 |
| AT-11 | DSP | aEEG 算法正确性 | S2 |
| AT-12 | DSP | LOD 金字塔完整性 | S2 |
| AT-13 | 伪迹 | Gap 检测与显示 | S2 |
| AT-14 | 伪迹 | Clipping 检测 | S2 |
| AT-15 | NIRS | 6通道趋势显示 | S3 |
| AT-16 | 视频 | 实时视频显示 | S3 |
| AT-17 | 视频 | 同步回放 | S3 |
| AT-18 | 回放 | 时间轴控制 | S4 |
| AT-19 | 回放 | Zero-Phase 滤波 | S4 |
| AT-20 | 存储 | 72h 数据存储 | S4 |
| AT-21 | 审计 | 操作日志完整性 | S5 |
| AT-22 | 稳定性 | 72h 连续运行 | S5 |
| **AT-23** | **UI** | **增益档位(含1000μV/cm)** | **S1** |
| **AT-24** | **存储** | **300GiB滚动清理** | **S4** |
| **AT-25** | **医学合规** | **aEEG医学合规** | **S2** |
| **AT-26** | **医学合规** | **NIRS职责边界** | **S3** |

---

## Sprint 1 验收测试

### AT-01: EEG 数据包解析

**前置条件**: 模拟串口数据源或实际设备

**测试步骤**:
1. 启动数据采集
2. 接收 1000 个数据包
3. 验证解析结果

**验收标准**:
- [ ] 包头识别正确 (0xAA 0x55)
- [ ] CRC 校验通过率 > 99.9%
- [ ] 4 通道数据完整 (CH1-CH4)
- [ ] 数据范围在 ±2500 μV
- [ ] 采样率确认为 160 Hz (1000 包 / 6.25 秒 = 160)

**测试数据**:
```
输入: 模拟 EEG 包 (40 bytes)
预期: data[0-2] 正确解析为 CH1-CH3
      data[3] 为 GS histogram bin
      scale_factor = 0.076 μV/LSB
```

---

### AT-03: 无锁缓冲吞吐量

**前置条件**: RingBuffer 实现完成

**测试步骤**:
1. 生产者线程以 160 Hz × 4 通道写入数据
2. 消费者线程以 120 Hz 读取数据
3. 运行 60 秒

**验收标准**:
- [ ] 无数据丢失
- [ ] 无死锁或阻塞
- [ ] 生产者写入耗时 < 100 μs (P99)
- [ ] 消费者读取耗时 < 100 μs (P99)

**性能指标**:
```
写入吞吐量: 160 × 4 × 8 = 5120 bytes/sec
读取吞吐量: 120 × 视口样本数 bytes/frame
```

---

### AT-04: 生产者-消费者同步

**前置条件**: 双缓冲实现完成

**测试步骤**:
1. 生产者写入已知序列 (1, 2, 3, ...)
2. 消费者读取并验证序列
3. 验证无重复、无跳跃

**验收标准**:
- [ ] 序列连续性 100%
- [ ] Interlocked 操作正确
- [ ] 60 秒测试无异常

---

### AT-05: 120 FPS 稳定性

**前置条件**: Vortice 渲染底座完成

**测试步骤**:
1. 启动渲染循环
2. 显示 4 通道模拟波形
3. 运行 5 分钟

**验收标准**:
- [ ] 平均帧率 ≥ 120 FPS
- [ ] 帧时间 P99 < 12 ms
- [ ] 无可见掉帧
- [ ] CPU 占用 < 30%

**测量方法**:
```csharp
var sw = Stopwatch.StartNew();
int frameCount = 0;
while (running)
{
    RenderFrame();
    frameCount++;
    if (sw.ElapsedMilliseconds >= 5000)
    {
        double fps = frameCount / 5.0;
        Assert(fps >= 120);
        break;
    }
}
```

---

### AT-06: 4通道波形正确性

**前置条件**: 渲染底座完成

**测试步骤**:
1. 输入已知波形 (1Hz 正弦波, 50μV 幅度)
2. 截取渲染输出
3. 验证波形形态

**验收标准**:
- [ ] 4 通道均正确显示
- [ ] 幅度缩放正确 (50μV 对应预期像素高度)
- [ ] 频率正确 (1Hz = 1 周期/秒)
- [ ] 通道标签正确 (CH1-CH4)

---

### AT-07: DPI 切换

**前置条件**: 支持多 DPI 的显示器

**测试步骤**:
1. 在 100% DPI 下启动
2. 切换到 150% DPI
3. 切换到 200% DPI
4. 切回 100% DPI

**验收标准**:
- [ ] 波形清晰无模糊
- [ ] 文字清晰无锯齿
- [ ] 布局正确无错位
- [ ] 切换时无崩溃
- [ ] 切换时间 < 500 ms

---

### AT-08: DeviceLost 恢复

**前置条件**: 渲染底座完成

**测试步骤**:
1. 正常渲染中
2. 模拟设备丢失 (Alt+Ctrl+Del 或 RDP 断开)
3. 恢复桌面
4. 验证渲染恢复

**验收标准**:
- [ ] 检测到 DeviceLost
- [ ] 自动重建资源
- [ ] 恢复后正常渲染
- [ ] 无内存泄漏
- [ ] 恢复时间 < 2 秒

---

## Sprint 2 验收测试

### AT-09: 滤波器频率响应

**前置条件**: IIR 滤波器实现完成

**测试步骤**:
1. 生成扫频信号 (0.1 Hz - 80 Hz)
2. 通过各档位滤波器
3. 测量输出幅度

**验收标准**:
```yaml
HPF_0.5Hz:
  - 0.5 Hz: -3 dB ±0.5 dB
  - 0.25 Hz: < -6 dB
  - 2 Hz: > -0.5 dB

LPF_35Hz:
  - 35 Hz: -3 dB ±0.5 dB
  - 70 Hz: < -24 dB (4阶)
  - 10 Hz: > -0.5 dB

Notch_50Hz:
  - 50 Hz: < -20 dB
  - 45 Hz: > -1 dB
  - 55 Hz: > -1 dB
```

---

### AT-10: 滤波器稳定性

**前置条件**: 滤波器实现完成

**测试步骤**:
1. 72 小时连续滤波
2. 监控输出范围
3. 检测数值异常

**验收标准**:
- [ ] 无 NaN 或 Inf 输出
- [ ] 无累积漂移 > 0.01%
- [ ] 状态变量在合理范围
- [ ] 重置后正常工作

---

### AT-11: aEEG 算法正确性

**前置条件**: aEEG 处理器实现完成

**测试步骤**:
1. 输入已知 EEG 波形
2. 计算 aEEG 输出
3. 与参考实现对比

**验收标准**:
- [ ] 2-15 Hz 带通正确
- [ ] 包络提取误差 < 5%
- [ ] Min/Max 每秒输出正确
- [ ] 对数显示映射正确

---

### AT-12: LOD 金字塔完整性

**前置条件**: LOD 实现完成

**测试步骤**:
1. 写入 1 小时测试数据 (160 Hz)
2. 读取各层级数据
3. 验证 Min/Max 保持

**验收标准**:
- [ ] L0 原始数据完整
- [ ] 各层级降采样正确
- [ ] 尖峰值在所有层级保留
- [ ] 查询时间 < 10 ms

---

### AT-13: Gap 检测与显示

**前置条件**: 伪迹检测实现完成

**测试步骤**:
1. 注入含 Gap 的数据 (8 样本间隙)
2. 验证检测结果
3. 验证显示效果

**验收标准**:
- [ ] Gap > 4 样本 (25ms) 检测率 100%
- [ ] 断裂显示正确
- [ ] 灰色遮罩正确
- [ ] Gap ≤ 4 样本可选插值

---

### AT-14: Clipping 检测

**前置条件**: 伪迹检测实现完成

**测试步骤**:
1. 注入饱和数据 (连续 8 样本 = 2400 μV)
2. 验证检测结果
3. 验证红色标记

**验收标准**:
- [ ] 饱和检测正确
- [ ] Clip > 3 样本标记为红色
- [ ] Clip ≤ 3 样本忽略

---

## Sprint 3 验收测试

### AT-15: 6通道 NIRS 趋势显示

**前置条件**: NIRS 渲染完成

**测试步骤**:
1. 接收 6 通道 NIRS 数据
2. 验证趋势图显示
3. 验证数值显示

**验收标准**:
- [ ] 6 通道数据独立显示
- [ ] 分 3 组布局正确
- [ ] 数值范围 0-100%
- [ ] 危险区域 (< 50%) 红色显示

---

### AT-16: 实时视频显示

**前置条件**: 视频模块完成

**测试步骤**:
1. 连接摄像头
2. 启动实时显示
3. 验证画面

**验收标准**:
- [ ] 视频流显示正常
- [ ] 帧率 ≥ 15 FPS
- [ ] 延迟 < 200 ms
- [ ] 无画面撕裂

---

### AT-17: 视频同步回放

**前置条件**: 视频模块完成

**测试步骤**:
1. 录制 5 分钟视频 + EEG
2. 回放并跳转
3. 验证同步性

**验收标准**:
- [ ] 视频与 EEG 时间轴同步
- [ ] 跳转后同步误差 < 100 ms
- [ ] 播放/暂停正常

---

## Sprint 4 验收测试

### AT-18: 时间轴控制

**前置条件**: 时间轴服务完成

**测试步骤**:
1. 加载 3 小时历史数据
2. 测试跳转、缩放、拖动
3. 验证各控件响应

**验收标准**:
- [ ] 跳转响应 < 200 ms
- [ ] 缩放平滑
- [ ] 拖动实时更新
- [ ] EEG/aEEG/NIRS/视频 同步

---

### AT-19: Zero-Phase 滤波

**前置条件**: 回放模式完成

**测试步骤**:
1. 回放模式下应用滤波
2. 对比实时滤波输出
3. 验证零相位特性

**验收标准**:
- [ ] 相位延迟 = 0
- [ ] 幅度响应与实时模式一致
- [ ] 边界处理正确

---

### AT-20: 72h 数据存储

**前置条件**: 存储模块完成

**测试步骤**:
1. 模拟 72 小时数据写入
2. 验证文件完整性
3. 读取并校验

**验收标准**:
```yaml
数据量计算:
  EEG: 160 Hz × 4 ch × 2 bytes × 72h = 331 MB
  aEEG: 1 Hz × 4 ch × 8 bytes × 72h = 8 MB
  NIRS: 4 Hz × 6 ch × 4 bytes × 72h = 25 MB
  视频: ~5 GB (取决于码率)
  总计: ~6 GB
  
验收标准:
  - 数据完整性 100%
  - 读取速度 > 100 MB/s
  - 分段文件正确
```

---

## Sprint 5 验收测试

### AT-21: 审计日志完整性

**前置条件**: 审计模块完成

**测试步骤**:
1. 执行典型操作流程
2. 检查审计日志
3. 验证关键事件

**验收标准**:
- [ ] 监测开始/结束记录
- [ ] 滤波器变更记录
- [ ] 增益调整记录
- [ ] 截图/标注操作记录
- [ ] 异常事件记录

---

### AT-22: 72h 连续运行

**前置条件**: 全系统集成完成

**测试步骤**:
1. 启动完整监测
2. 连续运行 72 小时
3. 监控资源使用

**验收标准**:
- [ ] 无崩溃
- [ ] 无内存泄漏 (内存增长 < 10%)
- [ ] CPU 平均 < 25%
- [ ] 帧率稳定 ≥ 60 FPS
- [ ] 数据完整无丢失

---

## 测试数据生成

### 模拟 EEG 数据

```python
def generate_test_eeg(duration_sec, sample_rate=160):
    """生成测试用 EEG 数据"""
    t = np.arange(0, duration_sec, 1/sample_rate)
    
    # 4 通道数据
    ch1 = 30 * np.sin(2 * np.pi * 8 * t)   # 8 Hz alpha
    ch2 = 20 * np.sin(2 * np.pi * 12 * t)  # 12 Hz
    ch3 = 25 * np.sin(2 * np.pi * 4 * t)   # 4 Hz theta
    ch4 = ch1 - ch2  # 计算通道
    
    return np.stack([ch1, ch2, ch3, ch4])
```

### 模拟 NIRS 数据

```python
def generate_test_nirs(duration_sec, sample_rate=4):
    """生成测试用 NIRS 数据"""
    t = np.arange(0, duration_sec, 1/sample_rate)
    
    # 6 通道，基线 70%，缓慢波动
    baseline = 70
    channels = []
    for i in range(6):
        noise = 5 * np.sin(2 * np.pi * 0.05 * t + i)
        channels.append(baseline + noise + np.random.randn(len(t)))
    
    return np.stack(channels)
```

---

## v1.2 新增验收测试

### AT-23: 增益档位验收

**前置条件**: UI 功能可用

**测试步骤**:
1. 打开增益档位选择器
2. 验证所有档位可选
3. 切换到 1000 μV/cm
4. 验证波形正确缩放

**验收标准**:
- [ ] 包含 50, 100, 200, 500, **1000** μV/cm 五档
- [ ] 所有档位可选且切换正常
- [ ] 1000 μV/cm 档位存在且功能正常
- [ ] 波形缩放比例正确

**拒绝条件**: ❌ 缺少 1000 μV/cm 档位

---

### AT-24: 存储滚动清理验收

**前置条件**: 存储接近 300 GiB 上限

**测试步骤**:
1. 填充存储至接近上限（>270 GiB）
2. 继续监护产生新数据
3. 触发滚动清理
4. 验证监护连续性

**验收标准**:
- [ ] 存储上限检测正确（300 GiB）
- [ ] 最旧患者会话被整体删除
- [ ] 当前监护不中断
- [ ] 清理过程无数据丢失
- [ ] 删除操作有审计日志

**拒绝条件**: ❌ 清理过程中断当前监护或数据丢失

---

### AT-25: aEEG 医学合规验收

**前置条件**: aEEG 处理器实现完成

**测试步骤**:
1. 输入已知 burst/suppression 模式的 Raw EEG 数据
2. 观察 aEEG 输出
3. 与参考实现对比

**验收标准**:
- [ ] aEEG 处理流程正确：带通(2-15Hz) → 整流 → 直方图(15s GS) → 半对数映射
- [ ] aEEG 显示反映振幅分布包络，而非能量均值
- [ ] 15秒 GS 直方图正确生成
- [ ] 对数 Y 轴显示正确

**拒绝条件**: ❌ RMS-only 实现必须被拒绝

---

### AT-26: NIRS 职责边界验收

**前置条件**: NIRS 模块实现完成

**测试步骤**:
1. 检查 NIRS 阈值来源
2. 验证无软件推断逻辑
3. 检查配置入口是否预留

**验收标准**:
- [ ] 阈值完全来自设备规格/配置文件
- [ ] 无自适应修正逻辑
- [ ] 无智能判断逻辑
- [ ] 预留阈值配置界面入口
- [ ] 当前阈值标注为 TBD（待设备规格确认）

**拒绝条件**: ❌ 任何自适应修正或智能判断逻辑

---

**文档结束**
