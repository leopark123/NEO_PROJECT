# 📜 NEO 项目共识基线（Consensus Baseline）

> **文档版本**: v1.6  
> **冻结日期**: 2026-01-25  
> **状态**: 🔒 **已冻结** — 任何修改需指挥官批准  
> **作用**: 所有规格/Sprint/AI协作的共同起点，争议裁决依据  
> **v1.6变更**: 新增§十三 v1.2补充冻结（设备通信、时间戳、数据留存、增益档位、NIRS阈值）、ADR-012/013/014  
> **v1.5变更**: 新增§6.7视频设备参数（USB摄像头+主机时间戳）  
> **v1.4变更**: ADR-003标注被ADR-009替代、明确存储方案以ADR-009为准  
> **v1.3变更**: 新增ClockDomain定义、ADR-010(时间同步临时方案)  
> **v1.2变更**: 新增数据存储铁律(12-15)、ADR-009(SQLite+Chunk)  
> **v1.1变更**: 补充时间戳语义定义（样本中心时间）、Video帧时间戳优先级

---

## 一、项目性质与目标

### 1.1 项目定性

```
⚕️ 这是医疗级软件工程，不是实验项目
```

- 必须遵循 SRS / ICD / 可追溯 / 审计原则
- 不能以"能跑"为目标
- 复刻/重构医疗系统，不是自由设计
- 实际设备协议与文档是事实源

### 1.2 系统范围

| 模块 | 描述 | 状态 |
|------|------|------|
| EEG | 多通道脑电波形采集与显示 | ✅ 纳入 |
| aEEG | 振幅整合脑电图（独立诊断趋势） | ✅ 纳入 |
| NIRS | 近红外光谱（组织氧饱和度） | ✅ 纳入 |
| Video | 患者视频同步回放 | ✅ 纳入 |
| 长程监护 | 72小时连续记录 | ✅ 纳入 |

---

## 二、规范权威性（裁决依据）

### 2.1 规范优先级链

```
SRS > ICD > SDS/FDS > DSP_SPEC > ARCHITECTURE > Code
```

**裁决规则**：
- 当规格发生冲突时，按此优先级链裁决
- 高优先级规范覆盖低优先级
- 实现永远服从规格

### 2.2 ICD 是接口唯一权威

- AI 不得"猜接口"
- handoff 必须源自 ICD
- 任何接口变更需走评审流程

---

## 三、15条铁律（不可违反）

| # | 铁律 | 约束说明 |
|---|------|----------|
| 1 | **Raw数据永不修改** | 只追加，不改写/删除 |
| 2 | **不伪造波形** | 不跨gap插值，不制造假临床形态 |
| 3 | **Zoom Out必用Min/Max** | 禁止平均/跳点导致尖峰丢失 |
| 4 | **数值精度用double** | 滤波器系数、状态变量必须double |
| 5 | **缺失/饱和必须可见** | 用断裂/遮罩表达，不隐藏 |
| 6 | **渲染线程只Draw** | 不做O(N)计算，不分配大对象，不访问SQLite |
| 7 | **全链路可审计** | 参数变更、模式切换、异常都有记录 |
| 8 | **接口契约不可擅改** | 修改需走评审流程 |
| 9 | **临床安全 > 性能 > 美观** | 冲突时的优先级 |
| 10 | **测试先行** | 无测试的代码不合并 |
| 11 | **时间轴是一级公民** | 统一时间基准，禁止各模块独立时间源 |
| 12 | **Raw数据只追加** | append-only，禁止UPDATE/DELETE |
| 13 | **所有记录必须带时间戳** | t_us (int64 μs)，单调递增 |
| 14 | **存储必须支持72h+** | 有可验证的性能基线 |
| 15 | **存储方案变更需走ADR** | 禁止实现时"顺手"更换 |

---

## 四、架构形态共识

### 4.1 Pipeline 架构（非单体处理）

```
┌─────────────────────────────────────────────────────────────┐
│                    统一时间轴 (Global Timebase)              │
│                    int64 微秒(μs) · 单调递增                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────┐                                           │
│   │ EEG Pipeline │──→ 滤波 → LOD → 渲染 ─────────┐          │
│   └─────────────┘                                │          │
│                                                  │          │
│   ┌──────────────┐                               ▼          │
│   │ aEEG Pipeline │──→ 带通 → 整流 → 包络 → 渲染 ──→ 同步    │
│   └──────────────┘                               ▲   显示   │
│                                                  │          │
│   ┌──────────────┐                               │          │
│   │ NIRS Pipeline │──→ 趋势 → 分区 → 渲染 ───────┤          │
│   └──────────────┘                               │          │
│                                                  │          │
│   ┌───────────────┐                              │          │
│   │ Video Pipeline │──→ 帧同步 → 渲染 ───────────┘          │
│   └───────────────┘                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 核心架构原则

- EEG / aEEG / NIRS / Video **独立 Pipeline**
- DSP 与 Rendering **严格解耦**
- 文件化规格是系统真相源
- 所有模块共用**统一时间轴**

---

## 五、统一时间轴规范

### 5.1 时间基准定义

| 属性 | 规格 |
|------|------|
| 数据类型 | `int64` |
| 单位 | **微秒 (μs)** |
| 特性 | 单调递增 |
| 范围 | 0 ~ 2^63-1 (约292,000年) |
| 纪元 | 监护开始时刻 = 0 |

### 5.2 时钟域定义（ClockDomain）

```csharp
public enum ClockDomain
{
    Device,   // 设备硬件时钟（最高精度）
    Host,     // 主机单调时钟（当前使用）
    Unknown   // 时钟来源不可靠
}
```

**当前状态**: 采用 `Host` 时钟域（主机时间对齐），详见 ADR-010。

### 5.3 时间轴覆盖范围

**所有模块必须使用同一时间轴**：

- ✅ EEG 样本时间戳
- ✅ aEEG 样本时间戳
- ✅ NIRS 样本时间戳
- ✅ Video 帧时间戳
- ✅ UI 游标位置
- ✅ 用户标注/事件
- ✅ 审计日志时间戳

### 5.3 时间戳语义定义（防歧义）

```
⚠️ 关键约定：所有时间戳表示"样本或窗口的中心时间"
```

| 数据类型 | 时间戳含义 | 说明 |
|----------|-----------|------|
| EEG 样本 | 该样本的采集中心时刻 | 不是起始、不是结束 |
| NIRS 样本 | 该样本的采集中心时刻 | 同上 |
| aEEG 输出 | 该1秒窗口的中心时间点 | 例：窗口[T, T+1s]的ts = T+0.5s |
| LOD Min/Max | 该降采样区间的中心时间 | 同上 |
| Video 帧 | 该帧的曝光中心时刻 | 见下方优先级规则 |

**Video 帧时间戳来源优先级**：
1. 优先使用采集时的 Monotonic Clock
2. 如硬件提供 PTS (Presentation Timestamp)，需转换为 GlobalTime 微秒基准
3. 禁止使用系统墙钟时间 (wall clock) 作为主时间戳

### 5.4 禁止事项

```
❌ 禁止模块私有时间基准
❌ 禁止使用 DateTime 作为主时间轴
❌ 禁止跨模块时间不同步
❌ 禁止将时间戳解释为"窗口起始"或"窗口结束"（必须是中心）
```

---

## 六、关键参数事实（来自真实资料）

### 6.1 EEG 参数

| 参数 | 值 | 来源 |
|------|-----|------|
| 采样率 | **160 Hz** | readme.txt / SDS |
| 通道数 | **4** (3物理+1计算) | MR文档 |
| 数据格式 | int16, 0.076 μV/LSB | 示例代码 |
| 包速率 | 160 Hz | 示例代码 |
| 串口波特率 | 115200 bps | 示例代码 |

### 6.2 通道配置

| 通道 | 名称 | 导联 | 类型 |
|------|------|------|------|
| CH1 | 通道1 | C3-P3 (A-B) | 物理 |
| CH2 | 通道2 | C4-P4 (C-D) | 物理 |
| CH3 | 通道3 | P3-P4 (B-C) | 物理 |
| CH4 | 通道4 | C3-C4 (A-D) | **计算** |

### 6.3 滤波器参数

| 滤波器 | 类型 | 选项 | 默认 |
|--------|------|------|------|
| 高通 | Butterworth IIR 2阶 | 0.3, 0.5, 1.5 Hz | 0.5 Hz |
| 低通 | Butterworth IIR 4阶 | 15, 35, 50, 70 Hz | 35 Hz |
| Notch | IIR Notch 2阶 | 50, 60 Hz | 50 Hz |

### 6.4 aEEG 参数

| 参数 | 值 |
|------|-----|
| 带通滤波 | 2-15 Hz (Butterworth 4阶) |
| 整流 | 半波整流 \|x\| |
| 包络提取 | 滑动窗口 max |
| 平滑 | 15秒移动平均 |
| 输出率 | 1 Hz (min/max) |
| Y轴 | **对数刻度** |
| 显示范围 | 3小时 |
| GS直方图 | 230 bins, 15秒周期 |

### 6.5 NIRS 参数

| 参数 | 值 |
|------|-----|
| 通道数 | **6** |
| 显示分组 | 3 |
| 采样率 | 1-4 Hz |
| 值域 | 0-100% |
| 危险区 | 0-50% (红色) |
| 警告区 | 50-65% (黄色) |
| 正常区 | 65-100% (绿色) |

### 6.6 LOD / 长程监护

| 参数 | 值 |
|------|-----|
| 最大监护时长 | 72 小时 |
| 160Hz × 72h 样本数 | 41,472,000 |
| LOD 金字塔层数 | 26 层 |
| 抽取策略 | Min/Max 包络 |

### 6.7 视频设备参数（已确认）

| 参数 | 值 | 说明 |
|------|-----|------|
| 摄像头类型 | **通用 USB 摄像头 (UVC)** | 无专用 SDK |
| 硬件同步 | **无** | 无 Genlock、无 PTP |
| 时间戳来源 | **主机 Monotonic Clock** | 帧采集时打戳 |
| 同步精度目标 | **毫秒级 (±50-100ms)** | 非硬件对齐系统 |
| 帧率 | 30 fps（典型） | 取决于具体设备 |

**关键约束**：
- ❌ 不依赖设备提供的 PTS
- ❌ 不假设任何硬件同步能力
- ✅ 使用与 EEG 相同的主机时钟源
- ✅ 软件时间对齐，满足临床观察需求

---

## 七、AI 协作分工

### 7.1 角色定义

| Agent | 角色 | 职责范围 |
|-------|------|----------|
| **Claude Code** | DSP与算法工程师 | IIR滤波器、LOD金字塔、伪迹检测、aEEG处理链、数值稳定性、单元测试 |
| **Codex (OpenAI)** | 工程实现专家 | Vortice渲染底座、无锁缓冲、三层渲染、DPI/DeviceLost、资源管理、性能优化 |
| **ChatGPT** | 架构审查员 | 架构设计、文档审查、规格一致性检查、跨模块集成验收、指挥辅助 |
| **指挥官** | 项目总指挥 | 决策、验收、任务调度、规格冻结、争议裁决 |

### 7.2 协作机制

```
📌 核心理念：用文件当上下文，而不是用聊天当上下文
```

| 机制 | 说明 |
|------|------|
| System Prompt 文件化 | AI 行为被规格约束，可版本化、可审计 |
| 上下文分层 | Layer0(永久) + Layer1(Sprint) + Layer2(任务) |
| 交接摘要 | 模块间通过 handoff/ 目录交接 |
| 不依赖记忆 | 上下文丢失时，重新读取文件即可恢复 |

### 7.3 上下文加载清单

| Agent | 必读文件 |
|-------|----------|
| Claude Code | CONSTITUTION + CLAUDE_SYSTEM_PROMPT + DSP_SPEC + CONTEXT_BRIEF + TASK-xx + 依赖handoff |
| Codex | CONSTITUTION + CODEX_SYSTEM_PROMPT + ARCHITECTURE + CONTEXT_BRIEF + TASK-xx + 依赖handoff |
| ChatGPT | 全部 spec/ + 全部 handoff/（审查时） |

---

## 八、测试与可追溯性

### 8.1 测试层次

| 层次 | 目的 | 责任方 |
|------|------|--------|
| Unit Test | 算法正确性 | Claude Code |
| Integration Test | 模块集成（EEG+Video等） | Codex |
| Acceptance Test | 功能验收 | 指挥官 |
| Traceability | SRS→Test 追溯链 | ChatGPT审查 |

### 8.2 质量闸门（DoD）

每个任务完成必须满足：

- [ ] 编译通过 (`dotnet build`)
- [ ] 测试通过 (`dotnet test`)
- [ ] 规格未修改 (spec/ 无未授权变更)
- [ ] 宪法未违反 (11条铁律)
- [ ] 交接摘要 (handoff/xxx-api.md)
- [ ] 验收用例 (通过指定的 AT-xx)

### 8.3 Zero-Phase 回放

- 历史数据回放支持 **Zero-Phase 滤波**
- 前向+后向滤波，消除相位延迟
- 仅用于回放，不用于实时

---

## 九、14条架构决策记录（ADR）

| ADR | 决策 | 理由 |
|-----|------|------|
| ADR-001 | 统一时间轴：int64微秒 + UTC Offset | 支持Video同步、未来兼容 |
| ADR-002 | 渲染引擎：Vortice | 活跃维护，API兼容SharpDX |
| ADR-003 | ~~存储分层~~ **已被ADR-009替代** | 见ADR-009 |
| ADR-004 | Zoom Out：Min/Max包络 | LOD金字塔，尖峰保留 |
| ADR-005 | Gap处理：≤4样本可选插值，>4强制断裂 | 基于160Hz重算 |
| ADR-006 | 滤波器：double精度 | 极点接近单位圆 |
| ADR-007 | 数据交换：无锁双缓冲 | Owned Double Buffer |
| ADR-008 | 渲染：三层架构 | Grid缓存 + Waveform实时 + Overlay实时 |
| ADR-009 | **存储后端：SQLite + Chunk** | 零部署、嵌入式、**现行存储方案** |
| ADR-010 | **时间同步：主机时间对齐** | EEG/Video共用主机时钟 |
| ADR-011 | **视频同步：USB摄像头+软件对齐** | 无硬件同步、毫秒级精度 |
| ADR-012 | **时间戳统一主机打点** | 所有数据源(EEG/NIRS/Video)主机打点 |
| ADR-013 | **NIRS阈值/单位不推断** | 阈值通过配置加载，禁止软件推断 |
| ADR-014 | **300GiB滚动留存** | 按患者会话删除，不中断监护 |

> ⚠️ **存储方案以 ADR-009 为准**；**视频同步以 ADR-011 为准**；**时间戳策略以 ADR-012 为准**

---

## 十、执行节奏

### 10.1 开发策略

```
垂直切片法：先做通一条完整链路，再扩展规模
```

- Sprint 目标是"能力闭环"，不是"功能堆积"
- 参数与架构先冻结，再开发

### 10.2 Sprint 规划

| Sprint | 目标 | 交付物 |
|--------|------|--------|
| S1 | 渲染底座 | 4通道EEG + 6通道NIRS 实时显示框架 |
| S2 | DSP链路 | 多档位滤波器 + LOD(160Hz) + ZeroPhase |
| S3 | 集成 | aEEG独立链 + 视频同步模块 |
| S4 | 完整系统 | 回放 + 审计 + 72h压测 |

---

## 十一、目录结构

```
NEO-EEG-NIRS/
├── spec/                        # 规格文档（只读约定）
│   ├── CONSENSUS_BASELINE.md    # 👈 本文档
│   ├── 00_CONSTITUTION.md       # 11条铁律
│   ├── ARCHITECTURE.md          # 系统架构
│   ├── DSP_SPEC.md              # DSP处理规格
│   ├── ACCEPTANCE_TESTS.md      # 验收测试用例
│   ├── DECISIONS.md             # ADR记录
│   ├── CONTEXT_BRIEF.md         # Sprint上下文
│   ├── CLAUDE_SYSTEM_PROMPT.md  # Claude约束
│   ├── CODEX_SYSTEM_PROMPT.md   # Codex约束
│   └── tasks/                   # 任务卡
├── handoff/                     # 模块交接摘要
├── src/                         # 源代码
└── scripts/                     # 辅助脚本
```

---

## 十二、v1.2 补充冻结：设备通信、时间戳与数据留存

> **此节为 v1.2 版本新增冻结内容（2026-01-25）**

### 12.1 统一时间戳策略（ADR-012）

| 策略项 | 规格 |
|--------|------|
| 适用范围 | EEG / NIRS / Video 所有数据源 |
| 打点方式 | **主机打点**（数据到达主机时立即打戳） |
| 存储精度 | int64 微秒 (μs) |
| 对齐目标 | 毫秒级 (ms) 跨数据源对齐 |
| 时钟源 | 主机 Monotonic Clock（非墙钟） |
| 禁止事项 | ❌ 不依赖设备内部时钟、❌ 不使用设备PTS |

### 12.2 EEG RS232 接入

| 参数 | 值 |
|------|-----|
| 接口类型 | RS232 串口 |
| 波特率 | 115200 bps |
| 数据格式 | 8N1 |
| 帧头 | 0xAA 0x55 |
| 数据长度 | 36字节 (18个int16) |
| 校验方式 | 累加和CRC |
| 模块职责 | Ingest(接收) + Parser(解析) |

### 12.3 NIRS RS232 接入

| 参数 | 值 |
|------|-----|
| 接口类型 | RS232 串口 |
| 通道数 | 6 |
| 采样率 | 1-4 Hz |
| 阈值来源 | 设备配置加载（TBD） |
| 配置入口 | 预留阈值配置界面 |

**⚠️ ADR-013 约束**：NIRS 阈值/单位**禁止软件推断**，当前标注 TBD，待设备规格确认后通过配置加载。

### 12.4 USB 摄像头接入

| 参数 | 值 |
|------|-----|
| 设备类型 | 通用USB摄像头 |
| 协议 | UVC（即插即用） |
| SDK要求 | **无专用SDK** |
| 帧率 | 30 fps（典型） |
| 时间戳 | 主机采集时打戳（非设备PTS） |

### 12.5 增益档位配置

EEG波形显示增益档位**必须包含**以下选项：

| 档位 | 灵敏度 | 用途 |
|------|--------|------|
| 高灵敏度 | 50 μV/cm | 低幅信号观察 |
| 标准 | 100 μV/cm | 常规监护 |
| 中等 | 200 μV/cm | 中幅信号 |
| 低灵敏度 | 500 μV/cm | 高幅信号 |
| 超低灵敏度 | **1000 μV/cm** | 极高幅信号/伪迹观察 |

> ⚠️ **1000 μV/cm 档位为 v1.2 强制要求**

### 12.6 存储与数据留存（ADR-014）

| 策略项 | 规格 |
|--------|------|
| 存储上限 | **300 GiB**（可配置） |
| 活跃患者数 | 单一患者（同一时刻只监护1人） |
| 历史记录归属 | 绑定患者身份，不可混淆 |
| 超限处理 | 自动滚动删除最旧患者会话 |
| 删除粒度 | 按患者会话整体删除（非部分删除） |
| 删除保护 | 当前活跃监护数据**不可删除** |
| 监护连续性 | 存储清理**不中断**当前监护 |

### 12.7 数据导出功能

- **截图功能**：支持当前波形截图保存
- **打印功能**：支持波形打印输出
- **数据导出**：支持选定时间段数据导出

---

## 十三、冻结声明

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   本文档已于 2026-01-25 冻结 (v1.6)                         │
│                                                             │
│   ✅ 没有未解决的原则冲突                                    │
│   ✅ 没有架构方向分歧                                        │
│   ✅ 所有关键事实已经对齐                                    │
│   ✅ Claude 与 ChatGPT 共识已合并                            │
│   ✅ v1.2 补充冻结已整合（设备通信、时间戳、数据留存）        │
│                                                             │
│   任何修改需要：                                             │
│   1. 指挥官明确批准                                          │
│   2. 记录变更理由                                            │
│   3. 更新版本号                                              │
│                                                             │
│   签署：指挥官 ________________  日期：2026-01-25            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 附录：变更记录

| 版本 | 日期 | 变更内容 | 批准人 |
|------|------|----------|--------|
| v1.0 | 2025-01-21 | 初始冻结版本（合并Claude+ChatGPT共识） | 指挥官 |
| v1.1 | 2025-01-21 | 补充§5.3时间戳语义定义、Video帧时间戳优先级 | 指挥官 |
| v1.2 | 2025-01-21 | 新增数据存储铁律(12-15)、ADR-009(SQLite+Chunk) | 指挥官 |
| v1.3 | 2025-01-21 | 新增§5.2 ClockDomain定义、ADR-010(时间同步临时方案) | 指挥官 |
| v1.4 | 2025-01-21 | ADR-003标注被ADR-009替代、明确存储方案以ADR-009为准 | 指挥官 |
| v1.5 | 2025-01-21 | 新增§6.7视频设备参数（USB摄像头+主机时间戳确认） | 指挥官 |
| v1.6 | 2026-01-25 | 新增§十二 v1.2补充冻结、ADR-012/013/014 | 指挥官 |

---

**🔒 END OF CONSENSUS BASELINE v1.6**
